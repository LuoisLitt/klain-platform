<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urenregistratie &amp; Facturatie Demo | klain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --black: #0f1117;
            --blue: #2563eb;
            --gray-dark: #6b7084;
            --gray-medium: #d1d5e0;
            --gray-light: #f7f8fa;
            --white: #ffffff;
            --green: #16a34a;
            --orange: #ea580c;
            --red: #dc2626;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        nav {
            position: fixed; top: 0; left: 0; right: 0; height: 64px;
            background: var(--white);
            z-index: 1000; border-bottom: 1px solid var(--gray-medium);
        }
        .nav-inner {
            max-width: 1400px; margin: 0 auto; padding: 0 24px;
            height: 100%; display: flex; align-items: center; justify-content: space-between;
        }
        .nav-cta {
            background: var(--blue); color: var(--white); padding: 10px 22px;
            border-radius: 10px; text-decoration: none; font-size: 14px; font-weight: 500;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-light);
            min-height: 100vh;
            color: var(--black);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .demo-banner {
            background: var(--blue); color: white; text-align: center;
            padding: 12px; font-size: 14px; font-weight: 500; margin-top: 64px;
        }
        .demo-banner a { color: white; margin-left: 12px; text-decoration: underline; }

        .container { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

        /* Tabs */
        .tabs {
            display: flex; gap: 4px; background: var(--white); border-radius: 12px;
            padding: 4px; margin-bottom: 28px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .tab {
            flex: 1; padding: 12px 16px; text-align: center; border-radius: 10px;
            font-size: 14px; font-weight: 500; cursor: pointer; border: none;
            background: transparent; color: var(--gray-dark); transition: all 0.2s;
        }
        .tab.active { background: var(--black); color: var(--white); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--white); border-radius: 16px; padding: 28px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 20px;
        }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 20px; }

        /* Form */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        label { font-size: 13px; font-weight: 500; color: var(--gray-dark); }
        input, select, textarea {
            padding: 10px 14px; border: 1px solid var(--gray-medium); border-radius: 8px;
            font-size: 14px; font-family: inherit; background: var(--white); color: var(--black);
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--blue); }
        textarea { resize: vertical; min-height: 70px; }

        .btn {
            padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; border: none; display: inline-flex;
            align-items: center; gap: 8px; text-decoration: none;
        }
        .btn-primary { background: var(--blue); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: var(--white); color: var(--black); border: 1px solid var(--gray-medium); }
        .btn-danger { background: var(--white); color: var(--red); border: 1px solid var(--gray-medium); }
        .btn-danger:hover { background: #fef2f2; }
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-dark); font-weight: 500; text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--gray-medium); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--gray-light); font-size: 14px; }
        td input, td select { width: 100%; padding: 8px 10px; font-size: 13px; }

        /* Stats */
        .stat-bar {
            display: flex; gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            flex: 1; background: var(--white); border-radius: 12px; padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .stat-card.highlight { background: var(--black); color: white; }
        .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-dark); margin-bottom: 4px; }
        .stat-card.highlight .stat-label { color: rgba(255,255,255,0.6); }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-card.highlight .stat-value { color: white; }

        /* Status badges */
        .badge {
            display: inline-block; padding: 4px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 500; cursor: pointer;
        }
        .badge-concept { background: #f3f4f6; color: var(--gray-dark); }
        .badge-verstuurd { background: #dbeafe; color: var(--blue); }
        .badge-betaald { background: #dcfce7; color: var(--green); }

        /* Logo upload */
        .logo-upload {
            width: 100px; height: 100px; border: 2px dashed var(--gray-medium);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; font-size: 12px; color: var(--gray-dark);
        }
        .logo-upload img { width: 100%; height: 100%; object-fit: contain; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 2000; align-items: center; justify-content: center; padding: 24px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--white); border-radius: 16px; max-width: 800px; width: 100%;
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 28px; border-bottom: 1px solid var(--gray-medium);
        }
        .modal-body { padding: 28px; }
        .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--gray-dark); }

        /* Invoice preview */
        .invoice-preview { font-size: 13px; line-height: 1.6; }
        .invoice-preview .inv-header { display: flex; justify-content: space-between; margin-bottom: 32px; }
        .invoice-preview .inv-logo img { max-height: 60px; }
        .invoice-preview .inv-company { text-align: right; color: var(--gray-dark); font-size: 12px; }
        .invoice-preview .inv-meta { display: flex; justify-content: space-between; margin-bottom: 28px; }
        .invoice-preview .inv-title { font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; margin-bottom: 16px; }
        .invoice-preview table th { font-size: 11px; background: var(--gray-light); }
        .invoice-preview table td { font-size: 12px; }
        .inv-totals { margin-top: 16px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; font-size: 13px; }
        .inv-totals .total-line { display: flex; gap: 32px; }
        .inv-totals .total-line.grand { font-weight: 700; font-size: 16px; border-top: 2px solid var(--black); padding-top: 6px; margin-top: 4px; }
        .inv-note { margin-top: 28px; padding-top: 16px; border-top: 1px solid var(--gray-medium); font-size: 12px; color: var(--gray-dark); }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .stat-bar { flex-direction: column; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-inner">
        <a href="https://klain.nl"><img src="images/klain-logo.jpg" height="36" alt="klain"></a>
        <a href="https://klain.nl/#contact" class="nav-cta">Plan een kennismaking</a>
    </div>
</nav>

<div class="demo-banner">
    Dit is een interactieve demo â€” alle data blijft lokaal in je browser.
    <a href="https://klain.nl/#contact">Meer weten?</a>
</div>

<div class="container">
    <div class="tabs">
        <button class="tab active" data-tab="profiel">Profiel</button>
        <button class="tab" data-tab="klanten">Klanten</button>
        <button class="tab" data-tab="factuur">Nieuwe factuur</button>
        <button class="tab" data-tab="overzicht">Overzicht</button>
    </div>

    <!-- PROFIEL -->
    <div class="tab-content active" id="tab-profiel">
        <div class="card">
            <div class="card-title">Bedrijfsprofiel</div>
            <div style="display:flex;gap:28px;align-items:flex-start;">
                <div>
                    <label style="margin-bottom:8px;display:block;">Logo</label>
                    <div class="logo-upload" id="logoUpload" onclick="document.getElementById('logoInput').click()">
                        <span id="logoPlaceholder">Upload</span>
                        <img id="logoPreview" style="display:none;">
                    </div>
                    <input type="file" id="logoInput" accept="image/*" style="display:none;">
                </div>
                <div class="form-grid" style="flex:1;">
                    <div class="form-group"><label>Bedrijfsnaam</label><input id="p-bedrijfsnaam"></div>
                    <div class="form-group"><label>Naam</label><input id="p-naam"></div>
                    <div class="form-group"><label>Adres</label><input id="p-adres"></div>
                    <div class="form-group"><label>Postcode</label><input id="p-postcode"></div>
                    <div class="form-group"><label>Stad</label><input id="p-stad"></div>
                    <div class="form-group"><label>KVK-nummer</label><input id="p-kvk"></div>
                    <div class="form-group"><label>BTW-nummer</label><input id="p-btw"></div>
                    <div class="form-group"><label>IBAN</label><input id="p-iban"></div>
                    <div class="form-group"><label>Standaard uurtarief</label><input id="p-tarief" type="number" step="0.01" min="0"></div>
                    <div class="form-group"><label>Betalingstermijn</label>
                        <select id="p-termijn">
                            <option value="14">14 dagen</option>
                            <option value="30" selected>30 dagen</option>
                            <option value="60">60 dagen</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="btn-row"><button class="btn btn-primary" onclick="saveProfiel()">Opslaan</button></div>
        </div>
    </div>

    <!-- KLANTEN -->
    <div class="tab-content" id="tab-klanten">
        <div class="card">
            <div class="card-title">Klant toevoegen</div>
            <div class="form-grid">
                <div class="form-group"><label>Bedrijfsnaam</label><input id="k-bedrijfsnaam"></div>
                <div class="form-group"><label>Contactpersoon</label><input id="k-contact"></div>
                <div class="form-group"><label>Adres</label><input id="k-adres"></div>
                <div class="form-group"><label>Postcode</label><input id="k-postcode"></div>
                <div class="form-group"><label>Stad</label><input id="k-stad"></div>
                <div class="form-group"><label>E-mail</label><input id="k-email" type="email"></div>
            </div>
            <div class="btn-row"><button class="btn btn-primary" onclick="addKlant()">Toevoegen</button></div>
        </div>
        <div class="card">
            <div class="card-title">Klanten</div>
            <table>
                <thead><tr><th>Bedrijf</th><th>Contact</th><th>Stad</th><th>E-mail</th><th></th></tr></thead>
                <tbody id="klantenTbody"></tbody>
            </table>
        </div>
    </div>

    <!-- NIEUWE FACTUUR -->
    <div class="tab-content" id="tab-factuur">
        <div class="card">
            <div class="card-title">Nieuwe factuur</div>
            <div class="form-grid">
                <div class="form-group"><label>Klant</label>
                    <select id="f-klant"><option value="">Selecteer een klant</option></select>
                </div>
                <div class="form-group"><label>Factuurnummer</label><input id="f-nummer" type="number" min="1"></div>
                <div class="form-group"><label>Factuurdatum</label><input id="f-datum" type="date"></div>
                <div class="form-group"><label>Vervaldatum</label><input id="f-verval" type="date"></div>
                <div class="form-group"><label>BTW-tarief</label>
                    <select id="f-btw">
                        <option value="21">21%</option>
                        <option value="9">9%</option>
                        <option value="0">0%</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Urenregels</div>
            <table>
                <thead><tr><th>Datum</th><th>Omschrijving</th><th>Uren</th><th>Tarief</th><th>Totaal</th><th></th></tr></thead>
                <tbody id="urenTbody"></tbody>
            </table>
            <div class="btn-row"><button class="btn btn-secondary btn-sm" onclick="addUrenRegel()">+ Regel toevoegen</button></div>
        </div>

        <div class="card">
            <div class="card-title">Extra kosten</div>
            <table>
                <thead><tr><th>Omschrijving</th><th>Bedrag</th><th></th></tr></thead>
                <tbody id="kostenTbody"></tbody>
            </table>
            <div class="btn-row"><button class="btn btn-secondary btn-sm" onclick="addKostenRegel()">+ Kosten toevoegen</button></div>
        </div>

        <div class="card">
            <div class="form-group full"><label>Notitie / betalingsinstructie</label><textarea id="f-notitie" rows="3"></textarea></div>
        </div>

        <div class="card" style="background:var(--gray-light);">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div class="btn-row" style="margin-top:0;">
                    <button class="btn btn-secondary" onclick="previewFactuur()">Preview factuur</button>
                    <button class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
                    <button class="btn btn-secondary" onclick="opslaanFactuur()">Opslaan in overzicht</button>
                </div>
                <div style="text-align:right;" id="liveTotals">
                    <div style="font-size:13px;color:var(--gray-dark);">Subtotaal: <span id="lt-sub">0,00</span></div>
                    <div style="font-size:13px;color:var(--gray-dark);">BTW: <span id="lt-btw">0,00</span></div>
                    <div style="font-size:20px;font-weight:700;margin-top:4px;">Totaal: <span id="lt-totaal">0,00</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERZICHT -->
    <div class="tab-content" id="tab-overzicht">
        <div class="stat-bar">
            <div class="stat-card highlight">
                <div class="stat-label">Openstaand</div>
                <div class="stat-value" id="ov-openstaand">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Totaal facturen</div>
                <div class="stat-value" id="ov-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Betaald</div>
                <div class="stat-value" style="color:var(--green);" id="ov-betaald">-</div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Facturen</div>
            <table>
                <thead><tr><th>#</th><th>Klant</th><th>Datum</th><th>Bedrag</th><th>Status</th><th></th></tr></thead>
                <tbody id="overzichtTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="previewModal">
    <div class="modal">
        <div class="modal-header">
            <span style="font-weight:600;">Factuurpreview</span>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="invoicePreviewContent" class="invoice-preview"></div>
        </div>
    </div>
</div>

<script>
// ---- DATA ----
const LS = {
    get(k, d) { try { return JSON.parse(localStorage.getItem('klain_uren_'+k)) || d; } catch { return d; } },
    set(k, v) { localStorage.setItem('klain_uren_'+k, JSON.stringify(v)); }
};

function initDemoData() {
    if (LS.get('inited', false)) return;
    LS.set('profiel', {
        bedrijfsnaam: 'Bakker Advies', naam: 'Jan Bakker', adres: 'Hoofdstraat 12',
        postcode: '7812 AB', stad: 'Emmen', kvk: '12345678', btw: 'NL123456789B01',
        iban: 'NL91 ABNA 0417 1643 00', tarief: 85, termijn: '30', logo: ''
    });
    LS.set('klanten', [{
        bedrijfsnaam: 'De Groot Techniek BV', contact: 'Peter de Groot',
        adres: 'Industrieweg 5', postcode: '7903 AC', stad: 'Hoogeveen', email: 'peter@degroottechniek.nl'
    }]);
    const facturen = [{
        nummer: 1, klantIdx: 0, datum: '2026-02-15', verval: '2026-03-17', btwTarief: 21,
        uren: [
            { datum: '2026-02-03', omschrijving: 'Projectanalyse en planning', uren: 6, tarief: 85 },
            { datum: '2026-02-07', omschrijving: 'Implementatie procesflow', uren: 8, tarief: 85 },
            { datum: '2026-02-12', omschrijving: 'Review en documentatie', uren: 4, tarief: 85 }
        ],
        kosten: [{ omschrijving: 'Reiskosten', bedrag: 45 }],
        notitie: '', status: 'verstuurd'
    }];
    LS.set('facturen', facturen);
    LS.set('nextNummer', 2);
    LS.set('inited', true);
}

// ---- TABS ----
document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('tab-' + t.dataset.tab).classList.add('active');
        if (t.dataset.tab === 'klanten') renderKlanten();
        if (t.dataset.tab === 'factuur') initFactuur();
        if (t.dataset.tab === 'overzicht') renderOverzicht();
        if (t.dataset.tab === 'profiel') loadProfiel();
    });
});

// ---- PROFIEL ----
function loadProfiel() {
    const p = LS.get('profiel', {});
    ['bedrijfsnaam','naam','adres','postcode','stad','kvk','btw','iban','tarief','termijn'].forEach(f => {
        const el = document.getElementById('p-' + f);
        if (el) el.value = p[f] || '';
    });
    if (p.logo) {
        document.getElementById('logoPreview').src = p.logo;
        document.getElementById('logoPreview').style.display = 'block';
        document.getElementById('logoPlaceholder').style.display = 'none';
    }
}

function saveProfiel() {
    const p = {};
    ['bedrijfsnaam','naam','adres','postcode','stad','kvk','btw','iban','tarief','termijn'].forEach(f => {
        p[f] = document.getElementById('p-' + f).value;
    });
    p.tarief = parseFloat(p.tarief) || 0;
    const prev = LS.get('profiel', {});
    p.logo = prev.logo || '';
    LS.set('profiel', p);
}

document.getElementById('logoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        const p = LS.get('profiel', {});
        p.logo = ev.target.result;
        LS.set('profiel', p);
        document.getElementById('logoPreview').src = ev.target.result;
        document.getElementById('logoPreview').style.display = 'block';
        document.getElementById('logoPlaceholder').style.display = 'none';
    };
    reader.readAsDataURL(file);
});

// ---- KLANTEN ----
function renderKlanten() {
    const klanten = LS.get('klanten', []);
    const tbody = document.getElementById('klantenTbody');
    tbody.innerHTML = klanten.map((k, i) =>
        `<tr><td>${k.bedrijfsnaam}</td><td>${k.contact}</td><td>${k.stad}</td><td>${k.email}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteKlant(${i})">Verwijder</button></td></tr>`
    ).join('');
}

function addKlant() {
    const klanten = LS.get('klanten', []);
    const k = {};
    ['bedrijfsnaam','contact','adres','postcode','stad','email'].forEach(f => {
        k[f] = document.getElementById('k-' + f).value;
    });
    if (!k.bedrijfsnaam) return;
    klanten.push(k);
    LS.set('klanten', klanten);
    ['bedrijfsnaam','contact','adres','postcode','stad','email'].forEach(f => {
        document.getElementById('k-' + f).value = '';
    });
    renderKlanten();
}

function deleteKlant(i) {
    const klanten = LS.get('klanten', []);
    klanten.splice(i, 1);
    LS.set('klanten', klanten);
    renderKlanten();
}

// ---- FACTUUR ----
function initFactuur() {
    const klanten = LS.get('klanten', []);
    const sel = document.getElementById('f-klant');
    sel.innerHTML = '<option value="">Selecteer een klant</option>' +
        klanten.map((k, i) => `<option value="${i}">${k.bedrijfsnaam}</option>`).join('');
    document.getElementById('f-nummer').value = LS.get('nextNummer', 1);
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('f-datum').value = today;
    updateVervalDatum();
    if (document.getElementById('urenTbody').children.length === 0) addUrenRegel();
}

document.getElementById('f-datum').addEventListener('change', updateVervalDatum);

function updateVervalDatum() {
    const p = LS.get('profiel', {});
    const d = new Date(document.getElementById('f-datum').value || new Date());
    d.setDate(d.getDate() + parseInt(p.termijn || 30));
    document.getElementById('f-verval').value = d.toISOString().split('T')[0];
}

function addUrenRegel() {
    const p = LS.get('profiel', {});
    const tbody = document.getElementById('urenTbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="date"></td>
        <td><input type="text" placeholder="Omschrijving"></td>
        <td><input type="number" min="0" step="0.25" value="0" style="width:70px;"></td>
        <td><input type="number" min="0" step="0.01" value="${p.tarief||0}" style="width:90px;"></td>
        <td class="regel-totaal" style="font-weight:500;">0,00</td>
        <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();berekenTotalen();">X</button></td>`;
    tbody.appendChild(tr);
    tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', berekenTotalen));
}

function addKostenRegel() {
    const tbody = document.getElementById('kostenTbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" placeholder="Omschrijving"></td>
        <td><input type="number" min="0" step="0.01" value="0" style="width:120px;"></td>
        <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove();berekenTotalen();">X</button></td>`;
    tbody.appendChild(tr);
    tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', berekenTotalen));
}

function berekenTotalen() {
    let sub = 0;
    document.querySelectorAll('#urenTbody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        const uren = parseFloat(inputs[2]?.value) || 0;
        const tarief = parseFloat(inputs[3]?.value) || 0;
        const t = uren * tarief;
        tr.querySelector('.regel-totaal').textContent = fmt(t);
        sub += t;
    });
    document.querySelectorAll('#kostenTbody tr').forEach(tr => {
        sub += parseFloat(tr.querySelectorAll('input')[1]?.value) || 0;
    });
    const btwPct = parseInt(document.getElementById('f-btw').value) || 0;
    const btw = sub * btwPct / 100;
    document.getElementById('lt-sub').textContent = fmt(sub);
    document.getElementById('lt-btw').textContent = fmt(btw);
    document.getElementById('lt-totaal').textContent = fmt(sub + btw);
}

document.getElementById('f-btw').addEventListener('change', berekenTotalen);

function fmt(n) { return n.toLocaleString('nl-NL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

function getFactuurData() {
    const klanten = LS.get('klanten', []);
    const profiel = LS.get('profiel', {});
    const klantIdx = parseInt(document.getElementById('f-klant').value);
    const klant = klanten[klantIdx] || {};
    const uren = [];
    document.querySelectorAll('#urenTbody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        uren.push({ datum: inputs[0].value, omschrijving: inputs[1].value, uren: parseFloat(inputs[2].value)||0, tarief: parseFloat(inputs[3].value)||0 });
    });
    const kosten = [];
    document.querySelectorAll('#kostenTbody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        kosten.push({ omschrijving: inputs[0].value, bedrag: parseFloat(inputs[1].value)||0 });
    });
    return {
        nummer: parseInt(document.getElementById('f-nummer').value)||1,
        klantIdx, klant, profiel,
        datum: document.getElementById('f-datum').value,
        verval: document.getElementById('f-verval').value,
        btwTarief: parseInt(document.getElementById('f-btw').value)||0,
        uren, kosten,
        notitie: document.getElementById('f-notitie').value
    };
}

function buildInvoiceHTML(data) {
    const p = data.profiel;
    const k = data.klant;
    let sub = 0;
    data.uren.forEach(r => sub += r.uren * r.tarief);
    data.kosten.forEach(r => sub += r.bedrag);
    const btw = sub * data.btwTarief / 100;
    const total = sub + btw;

    const logoHtml = p.logo ? `<img src="${p.logo}" style="max-height:60px;">` : `<div style="font-family:Fraunces,serif;font-size:24px;font-weight:700;">${p.bedrijfsnaam||'klain'}</div>`;

    return `
    <div class="inv-header">
        <div class="inv-logo">${logoHtml}</div>
        <div class="inv-company">
            <strong>${p.bedrijfsnaam||''}</strong><br>
            ${p.naam||''}<br>${p.adres||''}<br>${p.postcode||''} ${p.stad||''}<br>
            KVK: ${p.kvk||''}<br>BTW: ${p.btw||''}<br>IBAN: ${p.iban||''}
        </div>
    </div>
    <div class="inv-meta">
        <div>
            <strong>Factuur aan:</strong><br>
            ${k.bedrijfsnaam||''}<br>${k.contact?'t.a.v. '+k.contact+'<br>':''}${k.adres||''}<br>${k.postcode||''} ${k.stad||''}
        </div>
        <div style="text-align:right;">
            <div class="inv-title">Factuur</div>
            Factuurnummer: <strong>${data.nummer}</strong><br>
            Datum: ${data.datum}<br>
            Vervaldatum: ${data.verval}
        </div>
    </div>
    <table style="width:100%;margin-bottom:8px;">
        <thead><tr><th>Datum</th><th>Omschrijving</th><th style="text-align:right;">Uren</th><th style="text-align:right;">Tarief</th><th style="text-align:right;">Bedrag</th></tr></thead>
        <tbody>
        ${data.uren.map(r => `<tr><td>${r.datum}</td><td>${r.omschrijving}</td><td style="text-align:right;">${r.uren}</td><td style="text-align:right;">${fmt(r.tarief)}</td><td style="text-align:right;">${fmt(r.uren*r.tarief)}</td></tr>`).join('')}
        </tbody>
    </table>
    ${data.kosten.length ? `
    <table style="width:100%;margin-bottom:8px;">
        <thead><tr><th>Extra kosten</th><th style="text-align:right;">Bedrag</th></tr></thead>
        <tbody>${data.kosten.map(r => `<tr><td>${r.omschrijving}</td><td style="text-align:right;">${fmt(r.bedrag)}</td></tr>`).join('')}</tbody>
    </table>` : ''}
    <div class="inv-totals">
        <div class="total-line"><span>Subtotaal</span><span>${fmt(sub)}</span></div>
        <div class="total-line"><span>BTW ${data.btwTarief}%</span><span>${fmt(btw)}</span></div>
        <div class="total-line grand"><span>Totaal</span><span>${fmt(total)}</span></div>
    </div>
    <div class="inv-note">
        ${data.notitie ? data.notitie + '<br><br>' : ''}
        Gelieve te betalen voor ${data.verval} op IBAN ${p.iban||'[onbekend]'} t.n.v. ${p.bedrijfsnaam||''}.
    </div>`;
}

function previewFactuur() {
    const data = getFactuurData();
    document.getElementById('invoicePreviewContent').innerHTML = buildInvoiceHTML(data);
    document.getElementById('previewModal').classList.add('active');
}

function closeModal() { document.getElementById('previewModal').classList.remove('active'); }
document.getElementById('previewModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

function downloadPDF() {
    const data = getFactuurData();
    const container = document.createElement('div');
    container.className = 'invoice-preview';
    container.style.cssText = 'width:700px;padding:40px;background:white;font-family:DM Sans,sans-serif;position:absolute;left:-9999px;top:0;';
    container.innerHTML = buildInvoiceHTML(data);
    document.body.appendChild(container);

    html2canvas(container, { scale: 2, useCORS: true }).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const w = pdf.internal.pageSize.getWidth();
        const h = canvas.height * w / canvas.width;
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
        pdf.save(`factuur-${data.nummer}.pdf`);
        document.body.removeChild(container);
    });
}

function opslaanFactuur() {
    const data = getFactuurData();
    if (isNaN(data.klantIdx)) { alert('Selecteer een klant.'); return; }
    const facturen = LS.get('facturen', []);
    let sub = 0;
    data.uren.forEach(r => sub += r.uren * r.tarief);
    data.kosten.forEach(r => sub += r.bedrag);
    const btw = sub * data.btwTarief / 100;
    facturen.push({
        nummer: data.nummer, klantIdx: data.klantIdx, datum: data.datum, verval: data.verval,
        btwTarief: data.btwTarief, uren: data.uren, kosten: data.kosten, notitie: data.notitie,
        status: 'concept', totaal: sub + btw
    });
    LS.set('facturen', facturen);
    LS.set('nextNummer', data.nummer + 1);
    // Reset
    document.getElementById('urenTbody').innerHTML = '';
    document.getElementById('kostenTbody').innerHTML = '';
    document.getElementById('f-notitie').value = '';
    addUrenRegel();
    initFactuur();
    berekenTotalen();
    // Switch to overzicht
    document.querySelector('[data-tab="overzicht"]').click();
}

// ---- OVERZICHT ----
function renderOverzicht() {
    const facturen = LS.get('facturen', []);
    const klanten = LS.get('klanten', []);
    const tbody = document.getElementById('overzichtTbody');

    let openstaand = 0, betaald = 0;
    facturen.forEach(f => {
        let t = f.totaal;
        if (!t) {
            t = 0;
            (f.uren||[]).forEach(r => t += r.uren * r.tarief);
            (f.kosten||[]).forEach(r => t += r.bedrag);
            t += t * (f.btwTarief||0) / 100;
        }
        if (f.status === 'betaald') betaald += t;
        else openstaand += t;
    });

    document.getElementById('ov-openstaand').textContent = '\u20AC ' + fmt(openstaand);
    document.getElementById('ov-count').textContent = facturen.length;
    document.getElementById('ov-betaald').textContent = '\u20AC ' + fmt(betaald);

    const statusMap = { concept: 'badge-concept', verstuurd: 'badge-verstuurd', betaald: 'badge-betaald' };
    const nextStatus = { concept: 'verstuurd', verstuurd: 'betaald', betaald: 'concept' };

    tbody.innerHTML = facturen.map((f, i) => {
        const k = klanten[f.klantIdx] || {};
        let t = f.totaal;
        if (!t) { t = 0; (f.uren||[]).forEach(r => t += r.uren*r.tarief); (f.kosten||[]).forEach(r => t += r.bedrag); t += t*(f.btwTarief||0)/100; }
        return `<tr>
            <td>${f.nummer}</td><td>${k.bedrijfsnaam||'-'}</td><td>${f.datum}</td>
            <td style="font-weight:500;">\u20AC ${fmt(t)}</td>
            <td><span class="badge ${statusMap[f.status]||'badge-concept'}" onclick="cycleStatus(${i})">${f.status}</span></td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteFactuur(${i})">Verwijder</button></td>
        </tr>`;
    }).join('');
}

function cycleStatus(i) {
    const facturen = LS.get('facturen', []);
    const next = { concept: 'verstuurd', verstuurd: 'betaald', betaald: 'concept' };
    facturen[i].status = next[facturen[i].status] || 'concept';
    LS.set('facturen', facturen);
    renderOverzicht();
}

function deleteFactuur(i) {
    const facturen = LS.get('facturen', []);
    facturen.splice(i, 1);
    LS.set('facturen', facturen);
    renderOverzicht();
}

// ---- INIT ----
initDemoData();
loadProfiel();
</script>
</body>
</html>