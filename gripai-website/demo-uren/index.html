<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urenregistratie & Facturatie ‚Äî klain demo</title>
    <style>
        @font-face { font-family: 'DM Sans'; src: url('../fonts/dm-sans-latin.woff2') format('woff2'); font-weight: 100 900; font-display: swap; }
        @font-face { font-family: 'Fraunces'; src: url('../fonts/fraunces-latin.woff2') format('woff2'); font-weight: 100 900; font-display: swap; }
        @font-face { font-family: 'Fraunces'; src: url('../fonts/fraunces-italic-latin.woff2') format('woff2'); font-weight: 100 900; font-style: italic; font-display: swap; }

        :root {
            --black: #0f1117;
            --gray-900: #1a1d27;
            --gray-700: #3d4152;
            --gray-500: #6b7084;
            --gray-400: #8e93a6;
            --gray-200: #d1d5e0;
            --gray-100: #eef0f5;
            --gray-50: #f7f8fa;
            --white: #ffffff;
            --blue: #2563eb;
            --blue-hover: #1d4ed8;
            --blue-light: #eff6ff;
            --blue-muted: #dbeafe;
            --green: #16a34a;
            --green-light: #f0fdf4;
            --orange: #ea580c;
            --red: #dc2626;
            --red-light: #fef2f2;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-lg: 24px;
            --sidebar-w: 240px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--black); line-height: 1.6; background: var(--gray-50); -webkit-font-smoothing: antialiased; }

        .top-nav { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--white); border-bottom: 1px solid var(--gray-100); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .top-nav .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--black); }
        .top-nav .logo img { height: 32px; border-radius: 6px; }
        .top-nav .back-link { color: var(--gray-500); text-decoration: none; font-size: 14px; font-weight: 500; transition: color .2s; }
        .top-nav .back-link:hover { color: var(--blue); }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 8px; }
        .menu-toggle svg { width: 24px; height: 24px; stroke: var(--black); }

        .app { display: flex; margin-top: 56px; min-height: calc(100vh - 56px); }

        .sidebar { width: var(--sidebar-w); background: var(--white); border-right: 1px solid var(--gray-100); padding: 24px 16px; position: fixed; top: 56px; bottom: 0; overflow-y: auto; transition: transform .3s; }
        .sidebar h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--gray-400); margin-bottom: 12px; font-weight: 600; }
        .sidebar a { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: var(--radius-sm); color: var(--gray-700); text-decoration: none; font-size: 14px; font-weight: 500; transition: all .15s; margin-bottom: 2px; }
        .sidebar a:hover { background: var(--gray-50); color: var(--black); }
        .sidebar a.active { background: var(--blue-light); color: var(--blue); font-weight: 600; }
        .sidebar a svg { width: 18px; height: 18px; flex-shrink: 0; }
        .sidebar .demo-badge { margin-top: 24px; background: var(--blue-light); color: var(--blue); font-size: 12px; font-weight: 600; padding: 8px 12px; border-radius: var(--radius-sm); text-align: center; }

        .main { flex: 1; margin-left: var(--sidebar-w); padding: 32px 40px; max-width: 960px; }
        .main h1 { font-family: 'Fraunces', serif; font-size: 26px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.5px; }
        .main .subtitle { color: var(--gray-500); font-size: 14px; margin-bottom: 28px; }

        .card { background: var(--white); border: 1px solid var(--gray-100); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
        .kpi-card { background: var(--white); border: 1px solid var(--gray-100); border-radius: var(--radius); padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,.04); }
        .kpi-card .kpi-value { font-family: 'Fraunces', serif; font-size: 32px; font-weight: 700; letter-spacing: -1px; margin-bottom: 4px; color: var(--black); }
        .kpi-card .kpi-label { font-size: 13px; color: var(--gray-500); font-weight: 500; }
        .upsell-banner { background: var(--blue-light); border: 1px solid var(--blue-muted); border-radius: var(--radius); padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; margin-bottom: 8px; }
        .upsell-banner p { font-size: 14px; color: var(--gray-700); max-width: 560px; line-height: 1.5; }
        .upsell-banner .btn { white-space: nowrap; }

        .badge-late { background: var(--red-light); color: var(--red); }
        .btn-reminder { background: var(--red-light); color: var(--red); border: 1px solid #fecaca; font-size: 12px; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-family: inherit; transition: all .15s; margin-left: 6px; }
        .btn-reminder:hover { background: #fee2e2; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 300; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity .2s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal { background: var(--white); border-radius: var(--radius-lg); padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,.15); }
        .modal h3 { font-size: 18px; margin-bottom: 16px; }
        .modal pre { background: var(--gray-50); border: 1px solid var(--gray-100); border-radius: var(--radius-sm); padding: 16px; font-size: 13px; white-space: pre-wrap; line-height: 1.7; margin-bottom: 16px; font-family: inherit; }
        .modal .upsell-note { background: var(--blue-light); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 13px; color: var(--gray-700); margin-bottom: 16px; }
        .modal .upsell-note a { color: var(--blue); font-weight: 500; }

        .uren-info-banner { background: var(--blue-light); border: 1px solid var(--blue-muted); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 13px; color: var(--gray-700); margin-bottom: 16px; display: none; align-items: center; justify-content: space-between; gap: 12px; }
        .uren-info-banner.visible { display: flex; }
        .uren-info-banner a { color: var(--blue); font-weight: 500; text-decoration: none; }
        .uren-info-banner a:hover { text-decoration: underline; }
        .uren-info-banner .close-banner { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--gray-400); padding: 0 4px; line-height: 1; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-grid.full { grid-template-columns: 1fr; }
        label { display: block; font-size: 13px; font-weight: 500; color: var(--gray-700); margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--gray-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 14px; color: var(--black); background: var(--white); transition: border-color .2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }

        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: var(--radius-sm); font-family: inherit; font-size: 14px; font-weight: 500; border: none; cursor: pointer; transition: all .2s; text-decoration: none; }
        .btn-primary { background: var(--blue); color: var(--white); }
        .btn-primary:hover { background: var(--blue-hover); transform: translateY(-1px); }
        .btn-secondary { background: var(--gray-50); color: var(--gray-700); border: 1px solid var(--gray-200); }
        .btn-secondary:hover { background: var(--gray-100); }
        .btn-success { background: var(--green); color: var(--white); }
        .btn-success:hover { opacity: .9; }
        .btn-sm { padding: 6px 14px; font-size: 13px; }
        .btn-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; font-weight: 600; color: var(--gray-500); font-size: 12px; text-transform: uppercase; letter-spacing: .8px; padding: 10px 12px; border-bottom: 2px solid var(--gray-100); }
        td { padding: 12px; border-bottom: 1px solid var(--gray-100); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--gray-50); }

        .badge { display: inline-block; padding: 3px 10px; border-radius: 100px; font-size: 12px; font-weight: 600; }
        .badge-concept { background: var(--gray-100); color: var(--gray-500); }
        .badge-verzonden { background: var(--blue-light); color: var(--blue); }
        .badge-betaald { background: var(--green-light); color: var(--green); }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-400); font-size: 14px; }
        .delete-btn { background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 16px; padding: 4px 8px; border-radius: 4px; transition: all .15s; }
        .delete-btn:hover { background: #fef2f2; color: #dc2626; }
        .total-row td { font-weight: 600; border-top: 2px solid var(--gray-200); }

        .invoice-preview { background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 40px; max-width: 700px; margin: 20px auto; font-size: 14px; }
        .invoice-preview .inv-header { display: flex; justify-content: space-between; margin-bottom: 32px; }
        .invoice-preview .inv-header h2 { font-family: 'Fraunces', serif; font-size: 28px; color: var(--blue); }
        .invoice-preview .inv-meta { text-align: right; font-size: 13px; color: var(--gray-500); }
        .invoice-preview .inv-parties { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
        .invoice-preview .inv-parties h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-400); margin-bottom: 6px; }
        .invoice-preview .inv-parties p { font-size: 13px; line-height: 1.7; }
        .invoice-preview table th { font-size: 11px; }
        .invoice-preview .inv-totals { margin-top: 20px; display: flex; justify-content: flex-end; }
        .invoice-preview .inv-totals table { width: 280px; }
        .invoice-preview .inv-totals td { padding: 6px 12px; }
        .invoice-preview .inv-totals .grand-total td { font-size: 16px; font-weight: 700; color: var(--blue); border-top: 2px solid var(--blue); }
        .invoice-preview .inv-footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--gray-100); font-size: 12px; color: var(--gray-400); text-align: center; }

        .section { display: none; }
        .section.active { display: block; }

        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--gray-900); color: var(--white); padding: 12px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; z-index: 200; transform: translateY(80px); opacity: 0; transition: all .3s; }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* BTW Aangifte styles */
        .kpi-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .kpi-card-big { background: var(--white); border: 2px solid var(--gray-200); border-radius: var(--radius); padding: 28px; box-shadow: 0 2px 8px rgba(0,0,0,.06); text-align: center; }
        .kpi-card-big .kpi-value { font-family: 'Fraunces', serif; font-size: 36px; font-weight: 700; letter-spacing: -1px; }
        .kpi-card-big .kpi-label { font-size: 13px; color: var(--gray-500); font-weight: 500; margin-top: 4px; }
        .btw-positive { color: var(--red); }
        .btw-negative { color: var(--green); }
        .deadline-banner { border-radius: var(--radius-sm); padding: 12px 16px; font-size: 14px; font-weight: 500; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .deadline-banner.urgent { background: #fff7ed; border: 1px solid #fed7aa; color: var(--orange); }
        .deadline-banner.info { background: var(--gray-50); border: 1px solid var(--gray-100); color: var(--gray-500); }
        .kor-banner { background: #fefce8; border: 1px solid #fde68a; border-radius: var(--radius-sm); padding: 16px; font-size: 14px; color: #92400e; margin-bottom: 20px; line-height: 1.6; }
        .kor-banner a { color: #b45309; font-weight: 600; text-decoration: none; }
        .kor-banner a:hover { text-decoration: underline; }
        .rubrieken-card { background: var(--gray-50); border: 1px solid var(--gray-100); border-radius: var(--radius-sm); padding: 20px; margin-bottom: 16px; }
        .rubrieken-card .rubriek { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200); font-size: 14px; }
        .rubrieken-card .rubriek:last-child { border-bottom: none; font-weight: 600; }
        .rubrieken-card .rubriek strong { color: var(--blue); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); z-index: 90; }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; padding: 20px 16px; }
            .menu-toggle { display: block; }
            .form-grid { grid-template-columns: 1fr; }
            .invoice-preview { padding: 20px; }
            .invoice-preview .inv-parties { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: 1fr; }
            .kpi-grid-4 { grid-template-columns: 1fr 1fr; }
        }
        .upload-spinner { width: 36px; height: 36px; border: 3px solid var(--blue-muted); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #upload-zone-card:hover { border-color: var(--blue) !important; background: var(--blue-light) !important; }
    </style>
</head>
<body>

<nav class="top-nav">
    <a href="/" class="logo">
        <img src="../images/klain-logo.jpg" alt="klain">
    </a>
    <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">
        <svg fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <a href="https://klain.nl" class="back-link">&larr; Terug naar klain.nl</a>
</nav>

<div class="app">
    <aside class="sidebar">
        <h3>Menu</h3>
        <a href="#" class="active" data-section="dashboard">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
            Dashboard
        </a>
        <a href="#" data-section="profiel">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15A1.5 1.5 0 0121 4.5v15a1.5 1.5 0 01-1.5 1.5h-15A1.5 1.5 0 013 19.5v-15A1.5 1.5 0 014.5 3z"/></svg>
            Bedrijfsprofiel
        </a>
        <a href="#" data-section="klanten">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>
            Klanten
        </a>
        <a href="#" data-section="uren">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Uren
        </a>
        <a href="#" data-section="facturen">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
            Facturen
        </a>
        <a href="#" data-section="inkoop">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/></svg>
            Inkoop
        </a>
        <a href="#" data-section="btw">
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V13.5zm0 2.25h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V18zm2.498-6.75h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V13.5zm0 2.25h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V18zm2.504-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zm0 2.25h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V18zm2.498-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zM8.25 6h7.5v2.25h-7.5V6zM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0012 2.25z"/></svg>
            BTW Aangifte
        </a>
        <div class="demo-badge">&#129302; Demo &mdash; klain.nl</div>
    </aside>

    <main class="main">
        <!-- DASHBOARD -->
        <div class="section active" id="sec-dashboard">
            <h1>Dashboard</h1>
            <p class="subtitle">Overzicht van uw administratie</p>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-openstaand">&euro;0,00</div>
                    <div class="kpi-label">Openstaand bedrag</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-betaaltermijn">0 dagen</div>
                    <div class="kpi-label">Gem. betaaltermijn openstaand</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-omzet">&euro;0,00</div>
                    <div class="kpi-label">Omzet deze maand</div>
                </div>
            </div>
            <div class="upsell-banner">
                <p>Klain automatiseert uw debiteurenbeheer en stuurt automatisch betalingsherinneringen. Geen gedoe meer.</p>
                <a href="https://klain.nl/#contact" class="btn btn-primary">Vraag een AI Scan aan &rarr;</a>
            </div>
        </div>

        <!-- PROFIEL -->
        <div class="section" id="sec-profiel">
            <h1>Bedrijfsprofiel</h1>
            <p class="subtitle">Jouw bedrijfsgegevens voor op de factuur</p>
            <div class="card" style="margin-bottom:20px;">
                <h2>KVK opzoeken</h2>
                <div style="display:flex;gap:10px;align-items:flex-end">
                    <div style="flex:1"><label>KVK-nummer</label><input id="kvk-lookup-nr" placeholder="Bijv. 12345678" maxlength="8"></div>
                    <button class="btn btn-primary" onclick="kvkLookup()" id="kvk-lookup-btn">Opzoeken</button>
                </div>
            </div>
            <div class="card">
                <div class="form-grid">
                    <div><label>Bedrijfsnaam</label><input id="pf-naam" placeholder="Bijv. Klussenbedrijf Harms"></div>
                    <div><label>KVK-nummer</label><input id="pf-kvk" placeholder="12345678"></div>
                    <div><label>BTW-nummer</label><input id="pf-btw" placeholder="NL001234567B01"></div>
                    <div><label>IBAN</label><input id="pf-iban" placeholder="NL00RABO0123456789"></div>
                </div>
                <div class="form-grid full" style="margin-top:14px">
                    <div><label>Adres</label><input id="pf-adres" placeholder="Straat 1, 1234 AB Plaats"></div>
                </div>
                <div class="btn-row"><button class="btn btn-primary" onclick="saveProfiel()">Opslaan</button></div>
            </div>
        </div>

        <!-- KLANTEN -->
        <div class="section" id="sec-klanten">
            <h1>Klanten</h1>
            <p class="subtitle">Beheer je klantenbestand</p>
            <div class="card" style="margin-bottom:20px;">
                <h2>üîç KVK zoeken</h2>
                <div style="display:flex;gap:10px;align-items:flex-end">
                    <div style="flex:1"><label>Bedrijfsnaam of KVK-nummer</label><input id="kvk-search-input" placeholder="Bijv. bakker of 12345678"></div>
                    <button class="btn btn-primary" onclick="kvkSearch()" id="kvk-search-btn">Zoeken</button>
                </div>
                <div id="kvk-search-results" style="margin-top:12px"></div>
            </div>
            <div class="card">
                <h2>Klant toevoegen</h2>
                <div class="form-grid">
                    <div><label>Naam</label><input id="kl-naam" placeholder="Bedrijfsnaam"></div>
                    <div><label>E-mail</label><input id="kl-email" type="email" placeholder="info@voorbeeld.nl"></div>
                </div>
                <div class="form-grid full" style="margin-top:14px">
                    <div><label>Adres</label><input id="kl-adres" placeholder="Straat, postcode, plaats"></div>
                </div>
                <div class="btn-row"><button class="btn btn-primary" onclick="addKlant()">Toevoegen</button></div>
            </div>
            <div class="card">
                <h2>Klantenlijst</h2>
                <div id="klanten-list"></div>
            </div>
        </div>

        <!-- UREN -->
        <div class="section" id="sec-uren">
            <h1>Urenregistratie</h1>
            <p class="subtitle">Registreer uren per klant</p>
            <div class="card" style="margin-bottom:20px;border:1px solid var(--blue-muted);background:var(--blue-light);">
                <h2>‚è± Uren timer</h2>
                <div id="timer-display" style="font-family:'Fraunces',serif;font-size:48px;font-weight:700;letter-spacing:-2px;color:var(--black);margin:16px 0;">00:00:00</div>
                <div class="form-grid">
                    <div><label>Klant</label><select id="timer-klant"></select></div>
                    <div><label>Omschrijving</label><input id="timer-omschr" placeholder="Waar werk je aan?"></div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="timer-start-btn" onclick="timerStart()">‚ñ∂ Start</button>
                    <button class="btn btn-secondary" id="timer-stop-btn" onclick="timerStop()" disabled>‚èπ Stop</button>
                    <button class="btn btn-success" id="timer-register-btn" onclick="timerRegister()" disabled>‚úì Registreer</button>
                </div>
                <div id="timer-result" style="margin-top:12px;font-size:14px;color:var(--gray-500);display:none">Getimed: <strong id="timer-hours" style="color:var(--black)">0</strong> uur</div>
            </div>
            <div class="uren-info-banner" id="uren-banner">
                <span id="uren-banner-text"></span>
                <div style="display:flex;align-items:center;gap:12px">
                    <a href="https://klain.nl/#contact">Hoe werkt dat? &rarr;</a>
                    <button class="close-banner" onclick="document.getElementById('uren-banner').classList.remove('visible')">&times;</button>
                </div>
            </div>
            <div class="card">
                <h2>Uren invoeren</h2>
                <div class="form-grid">
                    <div><label>Klant</label><select id="ur-klant"></select></div>
                    <div><label>Datum</label><input id="ur-datum" type="date"></div>
                    <div><label>Omschrijving</label><input id="ur-omschr" placeholder="Werkzaamheden"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div><label>Uren</label><input id="ur-uren" type="number" step="0.25" min="0" value="1" oninput="calcUren()"></div>
                        <div><label>Uurtarief (&euro;)</label><input id="ur-tarief" type="number" min="0" value="85" oninput="calcUren()"></div>
                    </div>
                </div>
                <div style="margin-top:12px;font-size:14px;color:var(--gray-500)">Totaal: <strong id="ur-totaal" style="color:var(--black)">&euro;85,00</strong></div>
                <div class="btn-row"><button class="btn btn-primary" onclick="addUren()">Toevoegen</button></div>
            </div>
            <div class="card">
                <h2>Urenoverzicht</h2>
                <div id="uren-list"></div>
            </div>
        </div>

        <!-- FACTUREN -->
        <div class="section" id="sec-facturen">
            <h1>Facturen</h1>
            <p class="subtitle">Genereer en beheer je facturen</p>
            <div class="card">
                <h2>Factuur aanmaken</h2>
                <div class="form-grid">
                    <div><label>Klant</label><select id="fac-klant" onchange="loadOpenUren()"></select></div>
                    <div><label>Betaaltermijn</label>
                        <select id="fac-termijn">
                            <option value="14">14 dagen</option>
                            <option value="30" selected>30 dagen</option>
                            <option value="60">60 dagen</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid" style="margin-top:14px">
                    <div><label>BTW-tarief</label>
                        <select id="fac-btw-tarief">
                            <option value="21" selected>21%</option>
                            <option value="9">9%</option>
                            <option value="0">0% (vrijgesteld)</option>
                        </select>
                    </div>
                </div>
                <div id="fac-uren-select" style="margin-top:16px"></div>
                <div class="btn-row"><button class="btn btn-primary" onclick="generateFactuur()">Factuur genereren</button></div>
            </div>
            <div id="invoice-preview-container" style="display:none">
                <div class="btn-row" style="justify-content:flex-end;margin-bottom:10px">
                    <button class="btn btn-success" onclick="downloadPDF()">&#128196; Download PDF</button>
                </div>
                <div id="invoice-preview" class="invoice-preview"></div>
            </div>
            <div class="card" style="margin-top:20px">
                <h2>Factuuroverzicht</h2>
                <div id="facturen-list"></div>
            </div>
        </div>


        <!-- INKOOP -->
        <div class="section" id="sec-inkoop">
            <h1>Inkoop</h1>
            <p class="subtitle">Beheer uw inkoopfacturen en voorbelasting</p>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-inkoop-excl">&euro;0,00</div>
                    <div class="kpi-label">Totaal inkopen excl. BTW (deze maand)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-inkoop-btw">&euro;0,00</div>
                    <div class="kpi-label">Totale voorbelasting (deze maand)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-inkoop-aantal">0</div>
                    <div class="kpi-label">Aantal inkoopfacturen</div>
                </div>
            </div>


            <!-- Upload zone -->
            <div class="card" id="upload-zone-card" style="border: 2px dashed var(--gray-200); background: var(--white); text-align: center; padding: 32px; cursor: pointer; transition: all .2s;" onclick="document.getElementById('ink-file-input').click()" ondragover="event.preventDefault();this.style.borderColor='var(--blue)';this.style.background='var(--blue-light)'" ondragleave="this.style.borderColor='var(--gray-200)';this.style.background='var(--white)'" ondrop="event.preventDefault();this.style.borderColor='var(--gray-200)';this.style.background='var(--white)';simulateUpload(event.dataTransfer.files[0])">
                <div id="upload-default-state">
                    <div style="font-size: 32px; margin-bottom: 12px;">üìÑ</div>
                    <h2 style="margin-bottom: 8px;">Factuur uploaden</h2>
                    <p style="color: var(--blue); font-weight: 500; margin-bottom: 4px;">Klik om PDF of foto te uploaden</p>
                    <p style="color: var(--gray-400); font-size: 13px; margin-bottom: 12px;">of sleep hier naartoe</p>
                    <p style="color: var(--gray-400); font-size: 12px;">Ondersteund: PDF, JPG, PNG</p>
                </div>
                <div id="upload-loading-state" style="display:none">
                    <div class="upload-spinner"></div>
                    <p style="color: var(--blue); font-weight: 500; margin-top: 16px;">Klain leest uw factuur uit...</p>
                </div>
                <input type="file" id="ink-file-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="simulateUpload(this.files[0])">
            </div>
            <p style="font-size: 13px; color: var(--gray-400); text-align: center; margin-top: -12px; margin-bottom: 20px;">Klain koppelt dit aan uw BTW-aangifte. Nooit meer handmatig overtypen.</p>

            <div id="upload-success-banner" style="display:none; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: var(--radius-sm); padding: 14px 18px; margin-bottom: 16px;">
                <p style="color: #16a34a; font-weight: 500; font-size: 14px;">‚úì Klain heeft uw factuur uitgelezen. Controleer de gegevens en klik op Toevoegen.</p>
                <p style="color: var(--gray-400); font-size: 12px; margin-top: 4px;">In de volledige versie leest Klain echte facturen automatisch uit via AI.</p>
            </div>
            <div class="card">
                <h2>Inkoopfactuur toevoegen</h2>
                <div class="form-grid">
                    <div><label>Leverancier</label><input id="ink-leverancier" placeholder="Naam leverancier"></div>
                    <div><label>Datum</label><input id="ink-datum" type="date"></div>
                    <div><label>Omschrijving</label><input id="ink-omschr" placeholder="Omschrijving inkoop"></div>
                    <div><label>Bedrag excl. BTW (&euro;)</label><input id="ink-excl" type="number" min="0" step="0.01" value="0" oninput="calcInkoop()"></div>
                    <div><label>BTW-tarief</label>
                        <select id="ink-btw-tarief" onchange="calcInkoop()">
                            <option value="21" selected>21%</option>
                            <option value="9">9%</option>
                            <option value="0">0% (vrijgesteld)</option>
                        </select>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div><label>BTW-bedrag</label><input id="ink-btw" type="text" readonly style="background:var(--gray-50)" value="&euro;0,00"></div>
                        <div><label>Totaal incl. BTW</label><input id="ink-totaal" type="text" readonly style="background:var(--gray-50)" value="&euro;0,00"></div>
                    </div>
                </div>
                <div class="btn-row"><button class="btn btn-primary" onclick="addInkoop()">Toevoegen</button></div>
            </div>

            <div class="card">
                <h2>Inkoopoverzicht</h2>
                <div id="inkoop-list"></div>
            </div>
        </div>

        <!-- BTW AANGIFTE -->
        <div class="section" id="sec-btw">
            <h1>BTW Aangifte</h1>
            <p class="subtitle">Kwartaaloverzicht en aangifte-invulhulp</p>

            <div id="btw-deadline-banner"></div>

            <div class="card" style="margin-bottom:20px">
                <div class="form-grid">
                    <div>
                        <label>Kwartaal</label>
                        <select id="btw-kwartaal" onchange="updateBTW()">
                            <option value="1">Q1 2026 (jan ‚Äì mrt)</option>
                            <option value="2">Q2 2026 (apr ‚Äì jun)</option>
                            <option value="3">Q3 2026 (jul ‚Äì sep)</option>
                            <option value="4">Q4 2026 (okt ‚Äì dec)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="kpi-grid-4">
                <div class="kpi-card">
                    <div class="kpi-value" id="btw-omzet">&euro;0,00</div>
                    <div class="kpi-label">Omzet excl. BTW</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="btw-ontvangen">&euro;0,00</div>
                    <div class="kpi-label">BTW ontvangen</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="btw-voorbelasting">&euro;0,00</div>
                    <div class="kpi-label">Voorbelasting</div>
                </div>
                <div class="kpi-card-big">
                    <div class="kpi-value" id="btw-te-betalen">&euro;0,00</div>
                    <div class="kpi-label">Te betalen aan Belastingdienst</div>
                </div>
            </div>

            <div class="card" style="margin-bottom:20px">
                <label>BTW op uw inkopen dit kwartaal (voorbelasting)</label>
                <input id="btw-voorbelasting-input" type="text" readonly style="max-width:240px;margin-top:6px;background:var(--gray-50)">
                <p id="btw-voorbelasting-note" style="font-size:12px;color:var(--gray-400);margin-top:6px"></p>
            </div>

            <div class="card">
                <h2>Zo vult u uw aangifte in op Mijn Belastingdienst</h2>
                <div class="rubrieken-card">
                    <div class="rubriek"><span>Rubriek 1a ‚Äî Leveringen/diensten belast met hoog tarief</span><span id="rub-1a-omzet"></span></div>
                    <div class="rubriek"><span>Rubriek 1a ‚Äî BTW</span><strong id="rub-1a-btw"></strong></div>
                    <div class="rubriek"><span>Rubriek 5b ‚Äî Voorbelasting</span><strong id="rub-5b"></strong></div>
                    <div class="rubriek"><span>Rubriek 5g ‚Äî Totaal te betalen</span><strong id="rub-5g"></strong></div>
                </div>
                <div class="btn-row">
                    <a href="https://mijn.belastingdienst.nl" target="_blank" class="btn btn-primary">Open Mijn Belastingdienst &rarr;</a>
                </div>
            </div>

            <div id="btw-kor-banner"></div>

            <div class="card" style="margin-top:20px">
                <h2>Jaaroverzicht</h2>
                <p style="font-size:14px;color:var(--gray-500);margin-bottom:16px">Download een PDF met omzet per maand en BTW per kwartaal voor uw administratie.</p>
                <button class="btn btn-secondary" onclick="downloadJaaroverzichtPDF()">&#128196; Download jaaroverzicht (PDF)</button>
            </div>

            <div class="upsell-banner" style="margin-top:20px">
                <p>Klain installeert dit voor uw bedrijf ‚Äî inclusief persoonlijke uitleg en eerste kwartaal begeleiding. <strong>Quick Win: &euro;1.499 eenmalig.</strong></p>
                <a href="https://klain.nl/#contact" class="btn btn-primary">Plan een AI Scan &rarr;</a>
            </div>
        </div>
    </main>
</div>

<!-- REMINDER MODAL -->
<div class="modal-overlay" id="reminder-modal" onclick="if(event.target===this)closeReminderModal()">
    <div class="modal">
        <h3>&#128231; Betalingsherinnering</h3>
        <pre id="reminder-email-text"></pre>
        <div class="upsell-note">
            Klain stuurt deze herinneringen <strong>automatisch</strong>. Nooit meer handmatig achteraan bellen.<br>
            <a href="https://klain.nl/#contact">Meer informatie &rarr;</a>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="closeReminderModal()">Sluiten</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const LS=k=>JSON.parse(localStorage.getItem('klain_'+k)||'null');
const SS=(k,v)=>localStorage.setItem('klain_'+k,JSON.stringify(v));

function initData(){
    if(LS('init_v3')) return;
    // Clear old data
    ['init','init_v2','facturen','uren','klanten','profiel','nextFacNr','nextId'].forEach(function(k){localStorage.removeItem('klain_'+k)});

    SS('profiel',{naam:'Klussenbedrijf Harms',kvk:'12345678',btw:'NL001234567B01',adres:'Hoofdstraat 14, 7901 AA Hoogeveen',iban:'NL91RABO0123456789'});
    SS('klanten',[
        {id:1,naam:'Supermarkt De Boer',adres:'Hoofdstraat 12, 7811 EA Emmen',email:'info@supermarktdeboer.nl'},
        {id:2,naam:'Garage Jansen',adres:'Kanaalweg 8, 7903 AB Hoogeveen',email:'info@garagejansen.nl'}
    ]);
    SS('uren',[
        {id:1,klantId:1,datum:'2026-01-15',omschr:'Onderhoud airco',uren:3,tarief:85,gefactureerd:true},
        {id:2,klantId:1,datum:'2026-01-16',omschr:'Installatie verlichting',uren:5,tarief:85,gefactureerd:true},
        {id:3,klantId:1,datum:'2026-01-17',omschr:'Inspectie leidingwerk',uren:2,tarief:85,gefactureerd:true},
        {id:4,klantId:2,datum:'2026-02-10',omschr:'Elektra aanleggen',uren:5,tarief:85,gefactureerd:true},
        {id:5,klantId:2,datum:'2026-02-11',omschr:'Leidingwerk vervangen',uren:5,tarief:85,gefactureerd:true},
        {id:6,klantId:1,datum:'2026-03-01',omschr:'Reparatie cv-ketel',uren:8,tarief:85,gefactureerd:true},
        {id:7,klantId:1,datum:'2026-03-02',omschr:'Onderhoud installatie',uren:8.47,tarief:85,gefactureerd:true},
        {id:8,klantId:2,datum:'2026-02-28',omschr:'Afwerking kozijnen',uren:2.5,tarief:85,gefactureerd:false},
        {id:9,klantId:2,datum:'2026-03-01',omschr:'Schilderwerk kantoor',uren:3,tarief:85,gefactureerd:false}
    ]);

    // F-1001: ‚Ç¨1.000 excl BTW + 21% = ‚Ç¨1.210 incl (jan, Supermarkt De Boer)
    var regels1=[{id:1,klantId:1,datum:'2026-01-15',omschr:'Onderhoud airco',uren:3,tarief:85},{id:2,klantId:1,datum:'2026-01-16',omschr:'Installatie verlichting',uren:5,tarief:85},{id:3,klantId:1,datum:'2026-01-17',omschr:'Inspectie leidingwerk',uren:2,tarief:85}];

    // F-1002: ‚Ç¨850 excl BTW + 21% = ‚Ç¨1.028,50 incl (feb, Garage Jansen)
    var regels2=[{id:4,klantId:2,datum:'2026-02-10',omschr:'Elektra aanleggen',uren:5,tarief:85},{id:5,klantId:2,datum:'2026-02-11',omschr:'Leidingwerk vervangen',uren:5,tarief:85}];

    // F-1003: ‚Ç¨1.400 excl BTW + 21% = ‚Ç¨1.694 incl (mrt, Supermarkt De Boer)
    var regels3=[{id:6,klantId:1,datum:'2026-03-01',omschr:'Reparatie cv-ketel',uren:8,tarief:85},{id:7,klantId:1,datum:'2026-03-02',omschr:'Onderhoud installatie',uren:8.47,tarief:85}];

    SS('facturen',[
        {id:50,nummer:'F-1001',klantId:1,klantNaam:'Supermarkt De Boer',datum:'2026-01-30',vervalDatum:'2026-02-13',termijn:14,regels:regels1,subtotaal:1000,btwTarief:21,btw:210,totaal:1210,status:'Verzonden'},
        {id:51,nummer:'F-1002',klantId:2,klantNaam:'Garage Jansen',datum:'2026-02-15',vervalDatum:'2026-03-17',termijn:30,regels:regels2,subtotaal:850,btwTarief:21,btw:178.50,totaal:1028.50,status:'Betaald'},
        {id:52,nummer:'F-1003',klantId:1,klantNaam:'Supermarkt De Boer',datum:'2026-03-01',vervalDatum:'2026-03-31',termijn:30,regels:regels3,subtotaal:1400,btwTarief:21,btw:294,totaal:1694,status:'Concept'}
    ]);
    SS('nextFacNr',1004);
    SS('nextId',100);
    // Demo inkoopfacturen
    SS('inkoop',[
        {id:200,leverancier:'Kantoorartikelen Smit',datum:'2026-01-15',omschr:'Kantoorbenodigdheden',excl:150,btwTarief:21,btw:31.50,totaal:181.50},
        {id:201,leverancier:'Telecom Noord',datum:'2026-02-01',omschr:'Telefoonabonnement Q1',excl:45,btwTarief:21,btw:9.45,totaal:54.45},
        {id:202,leverancier:'Lease Auto BV',datum:'2026-03-01',omschr:'Leasekosten maart',excl:320,btwTarief:21,btw:67.20,totaal:387.20}
    ]);

    SS('init_v3',true);
}

function nid(){var i=(LS('nextId')||100)+1;SS('nextId',i);return i;}

document.querySelectorAll('.sidebar a[data-section]').forEach(function(a){
    a.addEventListener('click',function(e){
        e.preventDefault();
        document.querySelectorAll('.sidebar a').forEach(function(x){x.classList.remove('active')});
        a.classList.add('active');
        document.querySelectorAll('.section').forEach(function(s){s.classList.remove('active')});
        document.getElementById('sec-'+a.dataset.section).classList.add('active');
        document.querySelector('.sidebar').classList.remove('open');
        if(a.dataset.section==='dashboard') updateDashboard();
        if(a.dataset.section==='uren'||a.dataset.section==='facturen') populateKlantSelects();
        if(a.dataset.section==='uren'){renderUren();populateTimerKlant();}
        if(a.dataset.section==='facturen'){renderFacturen();loadOpenUren();}
        if(a.dataset.section==='klanten') renderKlanten();
        if(a.dataset.section==='profiel') loadProfiel();
        if(a.dataset.section==='inkoop'){renderInkoop();}
        if(a.dataset.section==='btw'){setDefaultKwartaal();updateBTW();}
    });
});

function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2500);}
function fmt(n){return n.toLocaleString('nl-NL',{minimumFractionDigits:2,maximumFractionDigits:2});}

function updateDashboard(){
    var facturen=LS('facturen')||[];
    var now=new Date();
    var openstaand=facturen.filter(function(f){return f.status==='Concept'||f.status==='Verzonden'});
    var openBedrag=openstaand.reduce(function(s,f){return s+f.totaal},0);
    document.getElementById('kpi-openstaand').textContent='\u20AC'+fmt(openBedrag);
    if(openstaand.length){
        var avgDagen=openstaand.reduce(function(s,f){return s+Math.floor((now-new Date(f.datum))/86400000)},0)/openstaand.length;
        document.getElementById('kpi-betaaltermijn').textContent=Math.round(avgDagen)+' dagen';
    } else {
        document.getElementById('kpi-betaaltermijn').textContent='0 dagen';
    }
    var thisMonth=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
    var omzet=facturen.filter(function(f){return f.datum.startsWith(thisMonth)}).reduce(function(s,f){return s+f.totaal},0);
    document.getElementById('kpi-omzet').textContent='\u20AC'+fmt(omzet);
}

function loadProfiel(){var p=LS('profiel')||{};document.getElementById('pf-naam').value=p.naam||'';document.getElementById('pf-kvk').value=p.kvk||'';document.getElementById('pf-btw').value=p.btw||'';document.getElementById('pf-iban').value=p.iban||'';document.getElementById('pf-adres').value=p.adres||'';}
function saveProfiel(){SS('profiel',{naam:document.getElementById('pf-naam').value,kvk:document.getElementById('pf-kvk').value,btw:document.getElementById('pf-btw').value,iban:document.getElementById('pf-iban').value,adres:document.getElementById('pf-adres').value});toast('Profiel opgeslagen \u2713');}

function addKlant(){var naam=document.getElementById('kl-naam').value.trim();if(!naam)return toast('Vul een naam in');var klanten=LS('klanten')||[];klanten.push({id:nid(),naam:naam,adres:document.getElementById('kl-adres').value,email:document.getElementById('kl-email').value});SS('klanten',klanten);document.getElementById('kl-naam').value='';document.getElementById('kl-adres').value='';document.getElementById('kl-email').value='';renderKlanten();toast('Klant toegevoegd \u2713');}
function deleteKlant(id){var k=LS('klanten')||[];k=k.filter(function(x){return x.id!==id});SS('klanten',k);renderKlanten();}
function renderKlanten(){var klanten=LS('klanten')||[];var el=document.getElementById('klanten-list');if(!klanten.length){el.innerHTML='<div class="empty-state"><p>Nog geen klanten</p></div>';return;}el.innerHTML='<table><thead><tr><th>Naam</th><th>Adres</th><th>E-mail</th><th></th></tr></thead><tbody>'+klanten.map(function(k){return '<tr><td>'+k.naam+'</td><td>'+k.adres+'</td><td>'+k.email+'</td><td><button class="delete-btn" onclick="deleteKlant('+k.id+')">&#10005;</button></td></tr>'}).join('')+'</tbody></table>';}

function populateKlantSelects(){var klanten=LS('klanten')||[];var opts=klanten.map(function(k){return '<option value="'+k.id+'">'+k.naam+'</option>'}).join('');var empty='<option value="">‚Äî Selecteer klant ‚Äî</option>';document.getElementById('ur-klant').innerHTML=empty+opts;document.getElementById('fac-klant').innerHTML=empty+opts;}
function calcUren(){var u=parseFloat(document.getElementById('ur-uren').value)||0;var t=parseFloat(document.getElementById('ur-tarief').value)||0;document.getElementById('ur-totaal').textContent='\u20AC'+fmt(u*t);}

function addUren(){
    var klantId=parseInt(document.getElementById('ur-klant').value);
    if(!klantId)return toast('Selecteer een klant');
    var uren=LS('uren')||[];
    uren.push({id:nid(),klantId:klantId,datum:document.getElementById('ur-datum').value||new Date().toISOString().slice(0,10),omschr:document.getElementById('ur-omschr').value||'Werkzaamheden',uren:parseFloat(document.getElementById('ur-uren').value)||1,tarief:parseFloat(document.getElementById('ur-tarief').value)||85,gefactureerd:false});
    SS('uren',uren);
    document.getElementById('ur-omschr').value='';
    renderUren();
    toast('Uren toegevoegd \u2713');
}

function deleteUur(id){var u=LS('uren')||[];u=u.filter(function(x){return x.id!==id});SS('uren',u);renderUren();}

function renderUren(){
    var uren=LS('uren')||[];
    var klanten=LS('klanten')||[];
    var kMap={};klanten.forEach(function(k){kMap[k.id]=k.naam});
    var el=document.getElementById('uren-list');
    var nietGefactureerd=uren.filter(function(u){return !u.gefactureerd});
    var totalUren=nietGefactureerd.reduce(function(s,u){return s+u.uren},0);
    var banner=document.getElementById('uren-banner');
    if(nietGefactureerd.length>=3){
        document.getElementById('uren-banner-text').textContent='U heeft '+totalUren+' uur geregistreerd. Klain kan uw urenstaten automatisch omzetten naar facturen.';
        banner.classList.add('visible');
    } else {
        banner.classList.remove('visible');
    }
    if(!uren.length){el.innerHTML='<div class="empty-state"><p>Nog geen uren geregistreerd</p></div>';return;}
    var total=0;
    el.innerHTML='<table><thead><tr><th>Datum</th><th>Klant</th><th>Omschrijving</th><th>Uren</th><th>Tarief</th><th>Totaal</th><th></th></tr></thead><tbody>'+uren.map(function(u){
        var t=u.uren*u.tarief;total+=t;
        return '<tr style="'+(u.gefactureerd?'opacity:.5':'')+'"><td>'+u.datum+'</td><td>'+(kMap[u.klantId]||'?')+'</td><td>'+u.omschr+'</td><td>'+u.uren+'</td><td>\u20AC'+fmt(u.tarief)+'</td><td>\u20AC'+fmt(t)+'</td><td>'+(u.gefactureerd?'<span style="color:var(--gray-400);font-size:12px">gefactureerd</span>':'<button class="delete-btn" onclick="deleteUur('+u.id+')">&#10005;</button>')+'</td></tr>';
    }).join('')+'<tr class="total-row"><td colspan="5">Totaal</td><td>\u20AC'+fmt(total)+'</td><td></td></tr></tbody></table>';
}

function loadOpenUren(){var klantId=parseInt(document.getElementById('fac-klant').value);var el=document.getElementById('fac-uren-select');if(!klantId){el.innerHTML='';return;}var uren=(LS('uren')||[]).filter(function(u){return u.klantId===klantId&&!u.gefactureerd});if(!uren.length){el.innerHTML='<p style="color:var(--gray-400);font-size:14px">Geen openstaande uren voor deze klant</p>';return;}el.innerHTML='<p style="font-size:13px;font-weight:600;margin-bottom:8px">Openstaande uren:</p><table><thead><tr><th><input type="checkbox" checked onchange="toggleAllUren(this)"></th><th>Datum</th><th>Omschrijving</th><th>Uren</th><th>Totaal</th></tr></thead><tbody>'+uren.map(function(u){return '<tr><td><input type="checkbox" checked value="'+u.id+'" class="uur-cb"></td><td>'+u.datum+'</td><td>'+u.omschr+'</td><td>'+u.uren+'</td><td>\u20AC'+fmt(u.uren*u.tarief)+'</td></tr>'}).join('')+'</tbody></table>';}
function toggleAllUren(cb){document.querySelectorAll('.uur-cb').forEach(function(c){c.checked=cb.checked});}

function generateFactuur(){
    var klantId=parseInt(document.getElementById('fac-klant').value);
    if(!klantId)return toast('Selecteer een klant');
    var checked=Array.from(document.querySelectorAll('.uur-cb:checked')).map(function(c){return parseInt(c.value)});
    if(!checked.length)return toast('Selecteer minstens \u00e9\u00e9n urenregel');
    var profiel=LS('profiel')||{};
    var klanten=LS('klanten')||[];
    var klant=klanten.find(function(k){return k.id===klantId});
    var uren=LS('uren')||[];
    var regels=uren.filter(function(u){return checked.indexOf(u.id)!==-1});
    var facNr=LS('nextFacNr')||1001;
    SS('nextFacNr',facNr+1);
    var today=new Date().toISOString().slice(0,10);
    var termijn=parseInt(document.getElementById('fac-termijn').value);
    var btwTarief=parseInt(document.getElementById('fac-btw-tarief').value);
    var vervalDatum=new Date(Date.now()+termijn*86400000).toISOString().slice(0,10);
    var subtotaal=regels.reduce(function(s,r){return s+r.uren*r.tarief},0);
    var btw=subtotaal*(btwTarief/100);
    var totaal=subtotaal+btw;
    regels.forEach(function(r){var u=uren.find(function(x){return x.id===r.id});if(u)u.gefactureerd=true;});
    SS('uren',uren);
    var factuur={id:nid(),nummer:'F-'+facNr,klantId:klantId,klantNaam:klant.naam,datum:today,vervalDatum:vervalDatum,termijn:termijn,regels:regels,subtotaal:subtotaal,btwTarief:btwTarief,btw:btw,totaal:totaal,status:'Concept'};
    var facturen=LS('facturen')||[];
    facturen.push(factuur);
    SS('facturen',facturen);
    renderInvoicePreview(factuur,profiel,klant);
    renderFacturen();
    loadOpenUren();
    toast('Factuur '+factuur.nummer+' aangemaakt \u2713');
}

function renderInvoicePreview(f,profiel,klant){
    var btwLabel='BTW ('+(f.btwTarief!=null?f.btwTarief:21)+'%)';
    document.getElementById('invoice-preview-container').style.display='block';
    document.getElementById('invoice-preview-container').dataset.factuurId=f.id;
    document.getElementById('invoice-preview').innerHTML='<div class="inv-header"><div><h2>FACTUUR</h2><p style="color:var(--gray-500);font-size:13px;margin-top:4px">'+f.nummer+'</p></div><div class="inv-meta"><p>Factuurdatum: '+f.datum+'</p><p>Vervaldatum: '+f.vervalDatum+'</p><p>Betaaltermijn: '+f.termijn+' dagen</p></div></div><div class="inv-parties"><div><h4>Van</h4><p><strong>'+(profiel.naam||'')+'</strong><br>'+(profiel.adres||'')+'<br>KVK: '+(profiel.kvk||'')+'<br>BTW: '+(profiel.btw||'')+'<br>IBAN: '+(profiel.iban||'')+'</p></div><div><h4>Aan</h4><p><strong>'+klant.naam+'</strong><br>'+klant.adres+'<br>'+klant.email+'</p></div></div><table><thead><tr><th>Datum</th><th>Omschrijving</th><th>Uren</th><th>Tarief</th><th style="text-align:right">Bedrag</th></tr></thead><tbody>'+f.regels.map(function(r){return '<tr><td>'+r.datum+'</td><td>'+r.omschr+'</td><td>'+r.uren+'</td><td>\u20AC'+fmt(r.tarief)+'</td><td style="text-align:right">\u20AC'+fmt(r.uren*r.tarief)+'</td></tr>'}).join('')+'</tbody></table><div class="inv-totals"><table><tr><td>Subtotaal excl. BTW</td><td style="text-align:right">\u20AC'+fmt(f.subtotaal)+'</td></tr><tr><td>'+btwLabel+'</td><td style="text-align:right">\u20AC'+fmt(f.btw)+'</td></tr><tr class="grand-total"><td>Totaal incl. BTW</td><td style="text-align:right">\u20AC'+fmt(f.totaal)+'</td></tr></table></div><div class="inv-footer">Gelieve het totaalbedrag over te maken op '+(profiel.iban||'IBAN')+' t.n.v. '+(profiel.naam||'')+' onder vermelding van '+f.nummer+'.</div>';
}

function downloadPDF(){
    var jsPDF=window.jspdf.jsPDF;var doc=new jsPDF();var fId=parseInt(document.getElementById('invoice-preview-container').dataset.factuurId);var facturen=LS('facturen')||[];var f=facturen.find(function(x){return x.id===fId});if(!f)return toast('Factuur niet gevonden');var profiel=LS('profiel')||{};var klant=(LS('klanten')||[]).find(function(k){return k.id===f.klantId})||{};var btwLabel='BTW ('+(f.btwTarief!=null?f.btwTarief:21)+'%)';var y=20;doc.setFontSize(24);doc.setTextColor(37,99,235);doc.text('FACTUUR',20,y);doc.setFontSize(11);doc.setTextColor(100);doc.text(f.nummer,20,y+8);doc.text('Factuurdatum: '+f.datum,190,y,{align:'right'});doc.text('Vervaldatum: '+f.vervalDatum,190,y+6,{align:'right'});y+=28;doc.setTextColor(50);doc.setFontSize(9);doc.text('VAN',20,y);doc.text('AAN',110,y);y+=6;doc.setFontSize(10);doc.setTextColor(30);doc.text(profiel.naam||'',20,y);doc.text(klant.naam||'',110,y);y+=5;doc.setFontSize(9);doc.setTextColor(80);doc.text(profiel.adres||'',20,y);doc.text(klant.adres||'',110,y);y+=5;doc.text('KVK: '+(profiel.kvk||''),20,y);doc.text(klant.email||'',110,y);y+=5;doc.text('BTW: '+(profiel.btw||''),20,y);y+=5;doc.text('IBAN: '+(profiel.iban||''),20,y);y+=14;doc.setFillColor(240,242,245);doc.rect(20,y-4,170,8,'F');doc.setFontSize(8);doc.setTextColor(100);doc.text('DATUM',22,y);doc.text('OMSCHRIJVING',52,y);doc.text('UREN',120,y);doc.text('TARIEF',140,y);doc.text('BEDRAG',175,y,{align:'right'});y+=8;doc.setTextColor(30);doc.setFontSize(9);f.regels.forEach(function(r){doc.text(r.datum,22,y);doc.text(r.omschr,52,y);doc.text(String(r.uren),122,y);doc.text('\u20AC'+fmt(r.tarief),140,y);doc.text('\u20AC'+fmt(r.uren*r.tarief),175,y,{align:'right'});y+=7;});y+=6;doc.setDrawColor(200);doc.line(120,y,190,y);y+=8;doc.text('Subtotaal excl. BTW',140,y);doc.text('\u20AC'+fmt(f.subtotaal),175,y,{align:'right'});y+=6;doc.text(btwLabel,140,y);doc.text('\u20AC'+fmt(f.btw),175,y,{align:'right'});y+=6;doc.setDrawColor(37,99,235);doc.line(120,y,190,y);y+=7;doc.setFontSize(11);doc.setTextColor(37,99,235);doc.text('Totaal incl. BTW',140,y);doc.text('\u20AC'+fmt(f.totaal),175,y,{align:'right'});y+=20;doc.setFontSize(8);doc.setTextColor(150);doc.text('Gelieve over te maken op '+(profiel.iban||'IBAN')+' t.n.v. '+(profiel.naam||'')+' o.v.v. '+f.nummer,105,y,{align:'center'});doc.save(f.nummer+'.pdf');toast('PDF gedownload \u2713');
}

function updateFactuurStatus(id,status){var facturen=LS('facturen')||[];var f=facturen.find(function(x){return x.id===id});if(f){f.status=status;SS('facturen',facturen);renderFacturen();updateDashboard();toast('Status bijgewerkt \u2713');}}

function renderFacturen(){
    var facturen=LS('facturen')||[];
    var el=document.getElementById('facturen-list');
    if(!facturen.length){el.innerHTML='<div class="empty-state"><p>Nog geen facturen</p></div>';return;}
    var now=new Date();
    var bc=function(s){return s==='Betaald'?'badge-betaald':s==='Verzonden'?'badge-verzonden':'badge-concept'};
    el.innerHTML='<table><thead><tr><th>Nummer</th><th>Klant</th><th>Datum</th><th>Excl. BTW</th><th>BTW</th><th>Totaal</th><th>Status</th><th></th></tr></thead><tbody>'+facturen.map(function(f){
        var daysSince=Math.floor((now-new Date(f.datum))/86400000);
        var isOverdue=f.status==='Verzonden'&&new Date(f.vervalDatum)<now;
        var statusCell='<span class="badge '+bc(f.status)+'">'+f.status+'</span>';
        if(isOverdue) statusCell+=' <span class="badge badge-late">Te laat</span>';
        var actionsCell='<select style="font-size:12px;padding:4px 8px;border:1px solid var(--gray-200);border-radius:6px;cursor:pointer" onchange="updateFactuurStatus('+f.id+',this.value)"><option'+(f.status==='Concept'?' selected':'')+'>Concept</option><option'+(f.status==='Verzonden'?' selected':'')+'>Verzonden</option><option'+(f.status==='Betaald'?' selected':'')+'>Betaald</option></select>';
        var emailSent=getEmailStatus()[f.id];if(emailSent){actionsCell+=' <button class="btn btn-sm" style="background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0;cursor:default" disabled>‚úì Verzonden</button>';}else{actionsCell+=' <button class="btn btn-sm btn-secondary" onclick="sendFactuurEmail('+f.id+',this)" id="email-btn-'+f.id+'">üìß Verstuur</button>';}
        if(isOverdue) actionsCell+='<button class="btn-reminder" onclick="showReminder('+f.id+')">Herinnering sturen</button>';
        return '<tr><td>'+f.nummer+'</td><td>'+f.klantNaam+'</td><td>'+f.datum+'</td><td>\u20AC'+fmt(f.subtotaal)+'</td><td>\u20AC'+fmt(f.btw)+'</td><td>\u20AC'+fmt(f.totaal)+'</td><td>'+statusCell+'</td><td>'+actionsCell+'</td></tr>';
    }).join('')+'</tbody></table>';
}

function showReminder(factuurId){
    var facturen=LS('facturen')||[];
    var f=facturen.find(function(x){return x.id===factuurId});
    if(!f)return;
    var profiel=LS('profiel')||{};
    var klanten=LS('klanten')||[];
    var klant=klanten.find(function(k){return k.id===f.klantId})||{};
    var email='Onderwerp: Herinnering factuur '+f.nummer+' \u2014 '+(profiel.naam||'[Bedrijfsnaam]')+'\n\nGeachte '+(klant.naam||'[klantnaam]')+',\n\nHierbij stuur ik u een vriendelijke herinnering voor factuur '+f.nummer+' van '+f.datum+' ter hoogte van \u20AC'+fmt(f.totaal)+'.\n\nOnze betalingstermijn is '+f.termijn+' dagen. Tot op heden hebben wij nog geen betaling ontvangen.\n\nWij verzoeken u het openstaande bedrag over te maken naar '+(profiel.iban||'[IBAN]')+' onder vermelding van factuurnummer '+f.nummer+'.\n\nMet vriendelijke groet,\n'+(profiel.naam||'[Bedrijfsnaam]');
    document.getElementById('reminder-email-text').textContent=email;
    document.getElementById('reminder-modal').classList.add('show');
}
function closeReminderModal(){document.getElementById('reminder-modal').classList.remove('show');}

// ============ BTW AANGIFTE ============

function setDefaultKwartaal(){
    var now=new Date();
    var q=Math.floor(now.getMonth()/3)+1;
    document.getElementById('btw-kwartaal').value=String(q);
}

function getQuarterMonths(q){
    q=parseInt(q);
    if(q===1) return [0,1,2];
    if(q===2) return [3,4,5];
    if(q===3) return [6,7,8];
    return [9,10,11];
}

function getQuarterDeadline(q){
    q=parseInt(q);
    if(q===1) return new Date(2026,3,30);
    if(q===2) return new Date(2026,6,31);
    if(q===3) return new Date(2026,9,31);
    return new Date(2027,0,31);
}

function getQuarterDeadlineLabel(q){
    q=parseInt(q);
    if(q===1) return '30 april 2026';
    if(q===2) return '31 juli 2026';
    if(q===3) return '31 oktober 2026';
    return '31 januari 2027';
}

function updateBTW(){
    var q=parseInt(document.getElementById('btw-kwartaal').value);
    var months=getQuarterMonths(q);
    var facturen=LS('facturen')||[];
    var year=2026;

    var qFacturen=facturen.filter(function(f){
        var d=new Date(f.datum);
        return d.getFullYear()===year && months.indexOf(d.getMonth())!==-1;
    });

    var omzetExcl=qFacturen.reduce(function(s,f){return s+f.subtotaal},0);
    var btwOntvangen=qFacturen.reduce(function(s,f){return s+f.btw},0);
    // Auto-calculate voorbelasting from inkoop
    var inkopen=LS('inkoop')||[];
    var qInkopen=inkopen.filter(function(i){
        var d=new Date(i.datum);
        return d.getFullYear()===year && months.indexOf(d.getMonth())!==-1;
    });
    var voorbelasting=qInkopen.reduce(function(s,i){return s+i.btw},0);
    document.getElementById('btw-voorbelasting-input').value='\u20AC'+fmt(voorbelasting);
    var noteEl=document.getElementById('btw-voorbelasting-note');
    if(qInkopen.length>0){
        noteEl.textContent='Berekend op basis van uw inkoopfacturen dit kwartaal ('+qInkopen.length+' facturen)';
        noteEl.style.color='var(--gray-400)';
    } else {
        noteEl.innerHTML='Geen inkoopfacturen ingevoerd \u2014 <a href="#" onclick="document.querySelector(\'[data-section=inkoop]\').click();return false" style="color:var(--blue)">voeg ze toe onder Inkoop</a>';
        noteEl.style.color='var(--gray-400)';
    }
    var teBetalen=btwOntvangen-voorbelasting;

    document.getElementById('btw-omzet').textContent='\u20AC'+fmt(omzetExcl);
    document.getElementById('btw-ontvangen').textContent='\u20AC'+fmt(btwOntvangen);
    document.getElementById('btw-voorbelasting').textContent='\u20AC'+fmt(voorbelasting);

    var teBetalenEl=document.getElementById('btw-te-betalen');
    if(teBetalen>0){
        teBetalenEl.className='kpi-value btw-positive';
        teBetalenEl.textContent='\u20AC'+fmt(teBetalen)+' (betalen)';
    } else if(teBetalen<0){
        teBetalenEl.className='kpi-value btw-negative';
        teBetalenEl.textContent='\u20AC'+fmt(Math.abs(teBetalen))+' (terug)';
    } else {
        teBetalenEl.className='kpi-value';
        teBetalenEl.textContent='\u20AC0,00';
    }

    // Rubrieken
    document.getElementById('rub-1a-omzet').textContent='\u20AC'+fmt(omzetExcl);
    document.getElementById('rub-1a-btw').textContent='\u20AC'+fmt(btwOntvangen);
    document.getElementById('rub-5b').textContent='\u20AC'+fmt(voorbelasting);
    document.getElementById('rub-5g').textContent='\u20AC'+fmt(teBetalen);

    // Deadline banner
    var deadline=getQuarterDeadline(q);
    var now=new Date();
    var daysLeft=Math.ceil((deadline-now)/86400000);
    var bannerEl=document.getElementById('btw-deadline-banner');
    var deadlineLabel=getQuarterDeadlineLabel(q);
    if(daysLeft>0 && daysLeft<=30){
        bannerEl.innerHTML='<div class="deadline-banner urgent">\u23F0 Uw BTW-aangifte Q'+q+' is over '+daysLeft+' dagen \u2014 deadline '+deadlineLabel+'</div>';
    } else if(daysLeft>30){
        bannerEl.innerHTML='<div class="deadline-banner info">\uD83D\uDCC5 Deadline BTW-aangifte Q'+q+': '+deadlineLabel+' (nog '+daysLeft+' dagen)</div>';
    } else {
        bannerEl.innerHTML='<div class="deadline-banner urgent">\u26A0\uFE0F Deadline BTW-aangifte Q'+q+' is verstreken ('+deadlineLabel+')</div>';
    }

    // KOR check
    var jaarFacturen=facturen.filter(function(f){return new Date(f.datum).getFullYear()===year});
    var jaarOmzet=jaarFacturen.reduce(function(s,f){return s+f.subtotaal},0);
    var korEl=document.getElementById('btw-kor-banner');
    if(jaarOmzet<20000){
        korEl.innerHTML='<div class="kor-banner">\u26A0\uFE0F Uw geschatte jaaromzet ligt onder \u20AC20.000. U komt mogelijk in aanmerking voor de <strong>KOR</strong> (kleineondernemersregeling) \u2014 dan doet u helemaal geen BTW-aangifte meer.<br><a href="https://www.belastingdienst.nl/wps/wcm/connect/bldcontentnl/belastingdienst/zakelijk/btw/hoe_werkt_de_btw/kleineondernemersregeling/kleineondernemersregeling" target="_blank">Meer informatie \u2192</a></div>';
    } else {
        korEl.innerHTML='';
    }
}

function downloadJaaroverzichtPDF(){
    var jsPDF=window.jspdf.jsPDF;
    var doc=new jsPDF();
    var profiel=LS('profiel')||{};
    var facturen=LS('facturen')||[];
    var year=2026;
    var jaarFacturen=facturen.filter(function(f){return new Date(f.datum).getFullYear()===year});

    var y=20;
    doc.setFontSize(20);doc.setTextColor(37,99,235);
    doc.text('Jaaroverzicht '+year,20,y);
    y+=12;
    doc.setFontSize(11);doc.setTextColor(50);
    doc.text((profiel.naam||'')+' | KVK: '+(profiel.kvk||''),20,y);
    y+=16;

    // Omzet per maand
    doc.setFontSize(14);doc.setTextColor(30);
    doc.text('Omzet per maand',20,y);y+=8;
    doc.setFillColor(240,242,245);doc.rect(20,y-4,170,8,'F');
    doc.setFontSize(9);doc.setTextColor(100);
    doc.text('Maand',22,y);doc.text('Omzet excl. BTW',90,y);doc.text('BTW',140,y);doc.text('Totaal',175,y,{align:'right'});
    y+=8;
    var maanden=['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'];
    var jaarTotaalExcl=0,jaarTotaalBtw=0,jaarTotaalIncl=0;
    doc.setTextColor(30);
    maanden.forEach(function(m,i){
        var mf=jaarFacturen.filter(function(f){return new Date(f.datum).getMonth()===i});
        var excl=mf.reduce(function(s,f){return s+f.subtotaal},0);
        var btw=mf.reduce(function(s,f){return s+f.btw},0);
        var incl=excl+btw;
        jaarTotaalExcl+=excl;jaarTotaalBtw+=btw;jaarTotaalIncl+=incl;
        if(excl>0){
            doc.text(m,22,y);
            doc.text('\u20AC'+fmt(excl),90,y);
            doc.text('\u20AC'+fmt(btw),140,y);
            doc.text('\u20AC'+fmt(incl),170,y,{align:'right'});
            y+=6;
        }
    });
    y+=2;doc.setDrawColor(37,99,235);doc.line(20,y,190,y);y+=6;
    doc.setFontSize(10);doc.setTextColor(37,99,235);
    doc.text('Totaal '+year,22,y);
    doc.text('\u20AC'+fmt(jaarTotaalExcl),90,y);
    doc.text('\u20AC'+fmt(jaarTotaalBtw),140,y);
    doc.text('\u20AC'+fmt(jaarTotaalIncl),170,y,{align:'right'});
    y+=16;

    // BTW per kwartaal
    doc.setFontSize(14);doc.setTextColor(30);
    doc.text('BTW per kwartaal',20,y);y+=8;
    doc.setFillColor(240,242,245);doc.rect(20,y-4,170,8,'F');
    doc.setFontSize(9);doc.setTextColor(100);
    doc.text('Kwartaal',22,y);doc.text('Omzet excl. BTW',90,y);doc.text('BTW',140,y);
    y+=8;doc.setTextColor(30);
    for(var qi=1;qi<=4;qi++){
        var qm=getQuarterMonths(qi);
        var qf=jaarFacturen.filter(function(f){return qm.indexOf(new Date(f.datum).getMonth())!==-1});
        var qExcl=qf.reduce(function(s,f){return s+f.subtotaal},0);
        var qBtw=qf.reduce(function(s,f){return s+f.btw},0);
        doc.text('Q'+qi+' '+year,22,y);
        doc.text('\u20AC'+fmt(qExcl),90,y);
        doc.text('\u20AC'+fmt(qBtw),140,y);
        y+=6;
    }

    doc.save('Jaaroverzicht-'+year+'.pdf');
    toast('Jaaroverzicht gedownload \u2713');
}


// ============ INKOOP ============

function calcInkoop(){
    var excl=parseFloat(document.getElementById('ink-excl').value)||0;
    var tarief=parseInt(document.getElementById('ink-btw-tarief').value);
    var btw=excl*(tarief/100);
    document.getElementById('ink-btw').value='\u20AC'+fmt(btw);
    document.getElementById('ink-totaal').value='\u20AC'+fmt(excl+btw);
}

function addInkoop(){
    var leverancier=document.getElementById('ink-leverancier').value.trim();
    if(!leverancier) return toast('Vul een leverancier in');
    var excl=parseFloat(document.getElementById('ink-excl').value)||0;
    if(excl<=0) return toast('Vul een bedrag in');
    var tarief=parseInt(document.getElementById('ink-btw-tarief').value);
    var btw=excl*(tarief/100);
    var inkopen=LS('inkoop')||[];
    inkopen.push({
        id:nid(),
        leverancier:leverancier,
        datum:document.getElementById('ink-datum').value||new Date().toISOString().slice(0,10),
        omschr:document.getElementById('ink-omschr').value||'',
        excl:excl,
        btwTarief:tarief,
        btw:Math.round(btw*100)/100,
        totaal:Math.round((excl+btw)*100)/100
    });
    SS('inkoop',inkopen);
    document.getElementById('ink-leverancier').value='';
    document.getElementById('ink-omschr').value='';
    document.getElementById('ink-excl').value='0';
    calcInkoop();
    renderInkoop();
    toast('Inkoopfactuur toegevoegd \u2713');
}

function deleteInkoop(id){
    var inkopen=LS('inkoop')||[];
    inkopen=inkopen.filter(function(i){return i.id!==id});
    SS('inkoop',inkopen);
    renderInkoop();
}

function renderInkoop(){
    var inkopen=LS('inkoop')||[];
    var now=new Date();
    var thisMonth=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
    var maandInkopen=inkopen.filter(function(i){return i.datum.startsWith(thisMonth)});
    var totExcl=maandInkopen.reduce(function(s,i){return s+i.excl},0);
    var totBtw=maandInkopen.reduce(function(s,i){return s+i.btw},0);

    document.getElementById('kpi-inkoop-excl').textContent='\u20AC'+fmt(totExcl);
    document.getElementById('kpi-inkoop-btw').textContent='\u20AC'+fmt(totBtw);
    document.getElementById('kpi-inkoop-aantal').textContent=String(inkopen.length);

    document.getElementById('ink-datum').value=new Date().toISOString().slice(0,10);

    var el=document.getElementById('inkoop-list');
    if(!inkopen.length){
        el.innerHTML='<div class="empty-state"><p>Nog geen inkoopfacturen</p></div>';
        return;
    }
    el.innerHTML='<table><thead><tr><th>Datum</th><th>Leverancier</th><th>Omschrijving</th><th>Excl. BTW</th><th>BTW</th><th>Totaal</th><th></th></tr></thead><tbody>'+inkopen.map(function(i){
        return '<tr><td>'+i.datum+'</td><td>'+i.leverancier+'</td><td>'+i.omschr+'</td><td>\u20AC'+fmt(i.excl)+'</td><td>\u20AC'+fmt(i.btw)+'</td><td>\u20AC'+fmt(i.totaal)+'</td><td><button class="delete-btn" onclick="deleteInkoop('+i.id+')">&#10005;</button></td></tr>';
    }).join('')+'</tbody></table>';
}


function simulateUpload(file) {
    if (!file) return;
    // Prevent card click from triggering during loading
    var card = document.getElementById('upload-zone-card');
    card.style.pointerEvents = 'none';
    document.getElementById('upload-default-state').style.display = 'none';
    document.getElementById('upload-loading-state').style.display = 'block';
    document.getElementById('upload-success-banner').style.display = 'none';

    var leveranciers = [
        { naam: 'Kantoorartikelen Smit', omschr: 'Kantoorbenodigdheden' },
        { naam: 'Office Depot', omschr: 'Printpapier en toners' },
        { naam: 'Telecom Noord', omschr: 'Telefoonabonnement' },
        { naam: 'Lease Auto BV', omschr: 'Leasekosten bedrijfsauto' },
        { naam: 'Drukkerij Jansen', omschr: 'Drukwerk visitekaartjes' }
    ];

    setTimeout(function() {
        var pick = leveranciers[Math.floor(Math.random() * leveranciers.length)];
        var bedrag = (Math.floor(Math.random() * 91) + 10) * 5; // 50-500 in steps of 5

        document.getElementById('ink-leverancier').value = pick.naam;
        document.getElementById('ink-datum').value = new Date().toISOString().slice(0, 10);
        document.getElementById('ink-omschr').value = pick.omschr;
        document.getElementById('ink-excl').value = bedrag;
        document.getElementById('ink-btw-tarief').value = '21';
        calcInkoop();

        // Reset upload zone
        document.getElementById('upload-default-state').style.display = 'block';
        document.getElementById('upload-loading-state').style.display = 'none';
        card.style.pointerEvents = 'auto';
        document.getElementById('ink-file-input').value = '';

        // Show success banner
        document.getElementById('upload-success-banner').style.display = 'block';
    }, 2000);
}


// ============ URENTIMER ============
var _timerInterval=null, _timerStart=null, _timerElapsed=0, _timerRunning=false;

function timerStart(){
    var klantId=parseInt(document.getElementById('timer-klant').value);
    if(!klantId) return toast('Selecteer eerst een klant');
    _timerStart=Date.now()-_timerElapsed;
    _timerRunning=true;
    document.getElementById('timer-start-btn').disabled=true;
    document.getElementById('timer-stop-btn').disabled=false;
    document.getElementById('timer-register-btn').disabled=true;
    document.getElementById('timer-result').style.display='none';
    _timerInterval=setInterval(function(){
        _timerElapsed=Date.now()-_timerStart;
        var s=Math.floor(_timerElapsed/1000);
        var h=Math.floor(s/3600);var m=Math.floor((s%3600)/60);var sec=s%60;
        document.getElementById('timer-display').textContent=
            String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
    },1000);
}

function timerStop(){
    clearInterval(_timerInterval);
    _timerRunning=false;
    document.getElementById('timer-start-btn').disabled=false;
    document.getElementById('timer-stop-btn').disabled=true;
    document.getElementById('timer-register-btn').disabled=false;
    var hours=_timerElapsed/3600000;
    var rounded=Math.ceil(hours*4)/4; // round up to 0.25
    if(rounded<0.25) rounded=0.25;
    document.getElementById('timer-hours').textContent=rounded;
    document.getElementById('timer-result').style.display='block';
}

function timerRegister(){
    var klantId=parseInt(document.getElementById('timer-klant').value);
    if(!klantId) return toast('Selecteer een klant');
    var hours=parseFloat(document.getElementById('timer-hours').textContent);
    if(!hours||hours<=0) return toast('Start eerst de timer');
    var omschr=document.getElementById('timer-omschr').value||'Werkzaamheden';
    var uren=LS('uren')||[];
    uren.push({id:nid(),klantId:klantId,datum:new Date().toISOString().slice(0,10),omschr:omschr,uren:hours,tarief:85,gefactureerd:false});
    SS('uren',uren);
    // Reset timer
    clearInterval(_timerInterval);
    _timerElapsed=0;_timerRunning=false;_timerStart=null;
    document.getElementById('timer-display').textContent='00:00:00';
    document.getElementById('timer-omschr').value='';
    document.getElementById('timer-start-btn').disabled=false;
    document.getElementById('timer-stop-btn').disabled=true;
    document.getElementById('timer-register-btn').disabled=true;
    document.getElementById('timer-result').style.display='none';
    renderUren();
    toast('Uren geregistreerd via timer ‚úì');
}

function populateTimerKlant(){
    var klanten=LS('klanten')||[];
    var opts='<option value="">‚Äî Selecteer klant ‚Äî</option>'+klanten.map(function(k){return '<option value="'+k.id+'">'+k.naam+'</option>'}).join('');
    document.getElementById('timer-klant').innerHTML=opts;
}

// ============ KVK OPZOEKEN (Profiel) ============
function kvkLookup(){
    var nr=document.getElementById('kvk-lookup-nr').value.trim();
    if(nr.length!==8||!/^\d+$/.test(nr)) return toast('Vul een geldig 8-cijferig KVK-nummer in');
    var btn=document.getElementById('kvk-lookup-btn');
    btn.disabled=true;btn.textContent='Zoeken...';
    setTimeout(function(){
        btn.disabled=false;btn.textContent='Opzoeken';
        if(nr==='12345678'){
            document.getElementById('pf-naam').value='Klussenbedrijf Harms';
            document.getElementById('pf-kvk').value='12345678';
            document.getElementById('pf-btw').value='NL001234567B01';
            document.getElementById('pf-iban').value='NL91RABO0123456789';
            document.getElementById('pf-adres').value='Hoofdstraat 14, 7901 AA Hoogeveen';
        } else {
            var namen=['Techniek Plus','Bouwbedrijf Noord','Van Dijk Services','Installatie Totaal','De Groot & Zn'];
            var plaatsen=['Emmen','Hoogeveen','Coevorden','Klazienaveen','Assen'];
            var idx=parseInt(nr.slice(-1))%5;
            document.getElementById('pf-naam').value=namen[idx];
            document.getElementById('pf-kvk').value=nr;
            document.getElementById('pf-btw').value='NL00'+nr+'B01';
            document.getElementById('pf-iban').value='NL'+nr.slice(0,2)+'RABO0'+nr;
            document.getElementById('pf-adres').value='Industrieweg '+(parseInt(nr.slice(-2)))+', 78'+nr.slice(4,6)+' AB '+plaatsen[idx];
        }
        toast('Bedrijfsgegevens ingevuld ‚úì');
    },1000);
}

// ============ KVK ZOEKEN (Klanten) ============
var _kvkDatabase=[
    {naam:'Bakkerij De Korst',adres:'Weerdingerstraat 45, 7811 AB Emmen',email:'info@dekorst.nl',kvk:'87654321'},
    {naam:'Bakker Advies BV',adres:'Schutstraat 12, 7902 EA Hoogeveen',email:'contact@bakkeradvies.nl',kvk:'87654322'},
    {naam:'Bakkerij Het Broodhuys',adres:'Hoofdstraat 88, 7741 JH Coevorden',email:'info@broodhuys.nl',kvk:'87654323'},
    {naam:'Garage Pietersen',adres:'Rondweg 5, 7824 AA Emmen',email:'info@garagepietersen.nl',kvk:'23456789'},
    {naam:'Autoservice Drenthe',adres:'Nijverheidsweg 19, 7903 AH Hoogeveen',email:'info@autoservicedrenthe.nl',kvk:'23456790'},
    {naam:'Schildersbedrijf Van Dijk',adres:'Kerkstraat 22, 7811 CC Emmen',email:'info@schildersvandijk.nl',kvk:'34567890'},
    {naam:'Aannemersbedrijf De Vries',adres:'Boslaan 7, 7904 JB Hoogeveen',email:'info@devries-bouw.nl',kvk:'34567891'},
    {naam:'Supermarkt Daling',adres:'Marktplein 3, 7741 GE Coevorden',email:'info@daling.nl',kvk:'45678901'},
    {naam:'Hoveniersbedrijf Groen',adres:'Tuinstraat 15, 7891 AB Klazienaveen',email:'info@hoveniersgroen.nl',kvk:'45678902'},
    {naam:'Installatiebedrijf Mulder',adres:'Industrieweg 44, 7903 AK Hoogeveen',email:'info@mulder-installatie.nl',kvk:'56789012'}
];

function kvkSearch(){
    var q=document.getElementById('kvk-search-input').value.trim().toLowerCase();
    if(!q) return toast('Vul een zoekterm in');
    var btn=document.getElementById('kvk-search-btn');
    btn.disabled=true;btn.textContent='Zoeken...';
    setTimeout(function(){
        btn.disabled=false;btn.textContent='Zoeken';
        var results=_kvkDatabase.filter(function(b){
            return b.naam.toLowerCase().indexOf(q)!==-1||b.kvk.indexOf(q)!==-1;
        }).slice(0,3);
        if(!results.length){
            // Generate some based on query
            results=[
                {naam:q.charAt(0).toUpperCase()+q.slice(1)+' BV',adres:'Hoofdstraat 1, 7811 AA Emmen',email:'info@'+q.replace(/\s/g,'')+'.nl',kvk:String(10000000+Math.floor(Math.random()*89999999))},
                {naam:q.charAt(0).toUpperCase()+q.slice(1)+' & Zn',adres:'Kerkweg 12, 7903 AB Hoogeveen',email:'contact@'+q.replace(/\s/g,'')+'.nl',kvk:String(10000000+Math.floor(Math.random()*89999999))}
            ];
        }
        var el=document.getElementById('kvk-search-results');
        el.innerHTML=results.map(function(r){
            return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--gray-100);border-radius:var(--radius-sm);margin-bottom:8px;background:var(--white)"><div><strong>'+r.naam+'</strong><br><span style="font-size:13px;color:var(--gray-500)">'+r.adres+' ‚Äî KVK '+r.kvk+'</span></div><button class="btn btn-sm btn-primary" onclick="kvkSelectKlant(''+r.naam.replace(/'/g,"\\'")+'',''+r.adres.replace(/'/g,"\\'")+'',''+r.email.replace(/'/g,"\\'")+'')">Toevoegen</button></div>';
        }).join('');
    },1000);
}

function kvkSelectKlant(naam,adres,email){
    document.getElementById('kl-naam').value=naam;
    document.getElementById('kl-adres').value=adres;
    document.getElementById('kl-email').value=email;
    document.getElementById('kvk-search-results').innerHTML='';
    document.getElementById('kvk-search-input').value='';
    toast('Gegevens ingevuld ‚Äî klik "Toevoegen" om op te slaan');
}

// ============ EMAIL VERZENDEN (Facturen) ============
function getEmailStatus(){return LS('factuur_email_status')||{};}
function setEmailStatus(id){var s=getEmailStatus();s[id]=true;SS('factuur_email_status',s);}

initData();
loadProfiel();
renderKlanten();
populateKlantSelects();
renderUren();
renderFacturen();
updateDashboard();
renderInkoop();
document.getElementById('ur-datum').value=new Date().toISOString().slice(0,10);
populateTimerKlant();
function sendFactuurEmail(id,btn){
    btn.disabled=true;btn.textContent='Versturen...';
    var facturen=LS('facturen')||[];
    var f=facturen.find(function(x){return x.id===id});
    setTimeout(function(){
        btn.style.background='#f0fdf4';btn.style.color='#16a34a';btn.style.border='1px solid #bbf7d0';
        btn.textContent='‚úì Verzonden';
        setEmailStatus(id);
        if(f){
            f.status='Verzonden';
            SS('facturen',facturen);
            toast('Factuur verzonden naar '+(f.klantNaam||'klant'));
            renderFacturen();
        }
    },1500);
}

</script>
<div style="background: var(--blue, #2563eb); padding: 48px 24px; text-align: center; margin-top: 60px;">
    <p style="color: rgba(255,255,255,0.8); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 12px;">Klain voor uw bedrijf</p>
    <h2 style="color: #fff; font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.5px;">Herkenbaar? Klain implementeert dit voor u.</h2>
    <p style="color: rgba(255,255,255,0.8); font-size: 16px; margin-bottom: 28px; max-width: 480px; margin-left: auto; margin-right: auto; line-height: 1.6;">Begin met een AI Scan van 1,5 uur. U krijgt een concreet rapport met uw automatiserings-kansen en wat het oplevert.</p>
    <a href="https://klain.nl/#contact" style="background: #fff; color: var(--blue, #2563eb); padding: 14px 32px; border-radius: 10px; font-size: 15px; font-weight: 600; text-decoration: none; display: inline-block;">Plan een AI Scan (‚Ç¨349) ‚Üí</a>
</div>
</body>
</html>
