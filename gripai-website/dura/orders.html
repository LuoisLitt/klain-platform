<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders — Dura Fulfilment</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script src="auth.js"></script>
    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html" class="logo">Dura <span>Fulfilment</span></a>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="orders.html" class="active">Orders</a></li>
                    <li><a href="voorraad.html">Voorraad</a></li>
                    <li><a href="verzendingen.html">Verzendingen</a></li>
                    <li><a href="rapportages.html">Rapportages</a></li>
                </ul>
            </div>
            <div class="nav-right">
                <div class="global-search" style="position:relative;">
                    <input type="text" id="globalSearch" placeholder="Zoek order, klant, SKU..."
                        style="width:220px;padding:8px 12px 8px 34px;border:1px solid #d2d2d7;border-radius:8px;font-size:13px;font-family:inherit;background:var(--gray-light);outline:none;transition:all 0.2s;"
                        onfocus="this.style.width='300px';this.style.borderColor='var(--blue)';this.style.background='#fff'"
                        onblur="this.style.width='220px';this.style.borderColor='#d2d2d7';this.style.background='var(--gray-light)'"
                        onkeydown="if(event.key==='Enter'){var q=this.value.trim();if(q){document.getElementById('searchInput').value=q;filterOrders();}}">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:#8e93a6;pointer-events:none;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </div>
                <a href="warehouse.html" class="btn-warehouse" title="Warehouse Display">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h17.25c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    Warehouse Display
                </a>
                <div class="nav-user">
                    <div class="user-avatar" id="userAvatar">DF</div>
                    <span class="user-name" id="userName">Demo Account</span>
                </div>
                <button class="hamburger" aria-label="Menu" aria-expanded="false">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Header -->
        <header class="page-header">
            <div class="header-title">
                <h1>Orders</h1>
                <p>Beheer en volg alle orders uit Goedgepickt</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportOrders()">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Exporteer
                </button>
                <button class="btn btn-primary">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Sync Goedgepickt
                </button>
            </div>
        </header>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="search-box">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" placeholder="Zoek op order ID, klant of product..." id="searchInput" onkeyup="filterOrders()">
            </div>
            <div class="filter-group">
                <select id="statusFilter" onchange="filterOrders()">
                    <option value="">Alle statussen</option>
                    <option value="ready_for_picking">Klaar voor picking</option>
                    <option value="processing">In verwerking</option>
                    <option value="picked">Gepickt</option>
                    <option value="packed">Ingepakt</option>
                    <option value="shipped">Verzonden</option>
                    <option value="completed">Afgerond</option>
                    <option value="delivered">Afgeleverd</option>
                    <option value="backorder">Backorder</option>
                    <option value="on_hold">On hold</option>
                </select>
                <select id="carrierFilter" onchange="filterOrders()">
                    <option value="">Alle carriers</option>
                    <option value="postnl">PostNL</option>
                    <option value="dhl">DHL</option>
                    <option value="dpd">DPD</option>
                </select>
                <input type="date" id="dateFilter" onchange="filterOrders()">
            </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row" id="statsRow">
            <!-- Stats worden dynamisch gevuld -->
            <div class="stat-box">
                <span class="stat-value" id="totalOrders">—</span>
                <span class="stat-label">Orders vandaag</span>
            </div>
            <div class="stat-box">
                <span class="stat-value green" id="completedOrders">—</span>
                <span class="stat-label">Afgerond</span>
            </div>
            <div class="stat-box">
                <span class="stat-value orange" id="readyForPickingOrders">—</span>
                <span class="stat-label">Klaar voor picking</span>
            </div>
            <div class="stat-box">
                <span class="stat-value red" id="backorderOrders">—</span>
                <span class="stat-label">Backorder</span>
            </div>
            <div class="stat-box">
                <span class="stat-value blue" id="onHoldOrders">—</span>
                <span class="stat-label">On hold</span>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="card">
            <table class="data-table" id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Klant</th>
                        <th>Items</th>
                        <th>Totaal</th>
                        <th>Status</th>
                        <th>Carrier</th>
                        <th>Aangemaakt</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                    <tr><td colspan="8" style="text-align:center;padding:40px;color:#999;">
                        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                            <div class="loading-spinner"></div>
                            Bezig met laden...
                        </div>
                    </td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Order <span id="modalOrderId"></span></h2>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div style="text-align:center;padding:40px;color:#999;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;">Order details laden...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .loading-spinner {
            width: 24px; height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .order-id-link {
            color: #2563eb;
            cursor: pointer;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-weight: 600;
            text-decoration: none;
        }
        .order-id-link:hover {
            text-decoration: underline;
        }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .detail-section { }
        .detail-section h3 { font-size: 14px; font-weight: 600; color: #8e93a6; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f2; font-size: 14px; }
        .detail-label { color: #6b7084; }
        .detail-value { font-weight: 500; text-align: right; }
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .detail-table th { text-align: left; padding: 10px 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #8e93a6; border-bottom: 2px solid #e8e8ed; }
        .detail-table td { padding: 12px; font-size: 14px; border-bottom: 1px solid #f0f0f2; }
        .timeline { position: relative; padding-left: 24px; }
        .timeline::before { content: ''; position: absolute; left: 7px; top: 4px; bottom: 4px; width: 2px; background: #e5e7eb; }
        .timeline-item { position: relative; padding-bottom: 20px; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: #e5e7eb; border: 2px solid #fff; }
        .timeline-item.completed .timeline-dot { background: #16a34a; }
        .timeline-item.active .timeline-dot { background: #2563eb; box-shadow: 0 0 0 4px rgba(37,99,235,0.2); }
        .timeline-content { padding-left: 4px; }
        .timeline-content strong { display: block; font-size: 14px; margin-bottom: 2px; }
        .timeline-content span { font-size: 13px; color: #6b7084; }
        @media (max-width: 768px) {
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>

    <script>
        // ============================================
        // LIVE API INTEGRATION
        // ============================================
        const API_BASE = window.DURA_API_BASE;
        const API_HEADERS = window.DURA_API_HEADERS;

        // XSS-safe helper: escape user/API data for the few cases where innerHTML is needed (e.g. SVG icons)
        function escapeHtml(str) {
            if (str == null) return '';
            const s = String(str);
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        // XSS-safe helper: create a table cell with text content
        function createTd(text, opts) {
            const td = document.createElement('td');
            if (opts && opts.style) td.style.cssText = opts.style;
            td.textContent = text;
            return td;
        }

        // XSS-safe helper: create a status badge element
        function createStatusBadge(statusClass, statusLabel) {
            const span = document.createElement('span');
            span.className = 'status-badge ' + statusClass;
            const dot = document.createElement('span');
            dot.className = 'status-dot';
            span.appendChild(dot);
            span.appendChild(document.createTextNode(statusLabel));
            return span;
        }

        // XSS-safe helper: create a carrier badge element
        function createCarrierBadge(carrierKey, carrierLabel) {
            if (!carrierKey) return document.createTextNode('\u2014');
            const span = document.createElement('span');
            span.className = 'carrier-badge ' + carrierKey;
            span.textContent = carrierLabel;
            return span;
        }

        // XSS-safe helper: create a detail row for modals
        function createDetailRow(label, value) {
            const row = document.createElement('div');
            row.className = 'detail-row';
            const lbl = document.createElement('span');
            lbl.className = 'detail-label';
            lbl.textContent = label;
            const val = document.createElement('span');
            val.className = 'detail-value';
            if (typeof value === 'string') {
                val.textContent = value;
            } else if (value instanceof HTMLElement) {
                val.appendChild(value);
            }
            row.appendChild(lbl);
            row.appendChild(val);
            return row;
        }

        // XSS-safe helper: create a timeline item
        function createTimelineItem(title, subtitle, cssClass) {
            const item = document.createElement('div');
            item.className = 'timeline-item ' + (cssClass || '');
            const dot = document.createElement('div');
            dot.className = 'timeline-dot';
            const content = document.createElement('div');
            content.className = 'timeline-content';
            const strong = document.createElement('strong');
            strong.textContent = title;
            const span = document.createElement('span');
            span.textContent = subtitle;
            content.appendChild(strong);
            content.appendChild(span);
            item.appendChild(dot);
            item.appendChild(content);
            return item;
        }

        const STATUS_MAP = {
            'open': 'Nieuw',
            'processing': 'In verwerking',
            'picked': 'Gepickt',
            'packed': 'Ingepakt',
            'shipped': 'Verzonden',
            'completed': 'Afgerond',
            'delivered': 'Afgeleverd',
            'ready_for_picking': 'Klaar voor picking',
            'backorder': 'Backorder',
            'on_hold': 'On hold'
        };

        const STATUS_CLASS_MAP = {
            'open': 'pending',
            'processing': 'picking',
            'picked': 'picking',
            'packed': 'packed',
            'shipped': 'shipped',
            'completed': 'delivered',
            'delivered': 'delivered',
            'ready_for_picking': 'pending',
            'backorder': 'critical',
            'on_hold': 'processing'
        };

        const SLA_HOURS = 24;

        function createSLABar(order) {
            if (!order.createDate) return null;

            var createTime = new Date(order.createDate).getTime();
            var slaMs = SLA_HOURS * 60 * 60 * 1000;
            var slaDeadline = createTime + slaMs;

            // Determine end time: shippedDate > finishDate > now
            var endTime;
            var isResolved = false;
            if (order.shippedDate) {
                endTime = new Date(order.shippedDate).getTime();
                isResolved = true;
            } else if (order.finishDate) {
                endTime = new Date(order.finishDate).getTime();
                isResolved = true;
            } else {
                endTime = Date.now();
            }

            var elapsed = endTime - createTime;
            var isOnTime = elapsed <= slaMs;
            var progress = Math.min(elapsed / slaMs, 1.5);

            var bar = document.createElement('div');
            bar.style.cssText = 'display:flex;align-items:center;gap:16px;padding:14px 18px;border-radius:12px;margin-bottom:16px;';

            var badgeColor, badgeText, detailText, barColor;

            if (isResolved && isOnTime) {
                bar.style.background = '#f0fdf4';
                bar.style.border = '1px solid rgba(22,163,74,0.15)';
                badgeColor = '#16a34a';
                badgeText = 'Op tijd';
                var hrs = Math.floor(elapsed / 3600000);
                var mins = Math.floor((elapsed % 3600000) / 60000);
                detailText = 'Verwerkt in ' + hrs + 'u ' + mins + 'min';
                barColor = '#16a34a';
            } else if (!isResolved && isOnTime) {
                bar.style.background = '#fff7ed';
                bar.style.border = '1px solid rgba(234,88,12,0.15)';
                badgeColor = '#ea580c';
                badgeText = 'In behandeling';
                var remaining = slaDeadline - endTime;
                var remHrs = Math.floor(remaining / 3600000);
                var remMins = Math.floor((remaining % 3600000) / 60000);
                detailText = 'Nog ' + remHrs + 'u ' + remMins + 'min binnen SLA';
                barColor = '#ea580c';
            } else {
                bar.style.background = '#fef2f2';
                bar.style.border = '1px solid rgba(220,38,38,0.15)';
                badgeColor = '#dc2626';
                badgeText = 'Vertraagd';
                var overMs = elapsed - slaMs;
                var overHrs = Math.floor(overMs / 3600000);
                var overMins = Math.floor((overMs % 3600000) / 60000);
                detailText = overHrs + 'u ' + overMins + 'min over SLA';
                if (isResolved) detailText = 'Verwerkt ' + detailText;
                barColor = '#dc2626';
            }

            var badge = document.createElement('span');
            badge.style.cssText = 'padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;color:white;background:' + badgeColor + ';flex-shrink:0;';
            badge.textContent = badgeText;
            bar.appendChild(badge);

            var progressOuter = document.createElement('div');
            progressOuter.style.cssText = 'flex:1;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;';
            var progressInner = document.createElement('div');
            progressInner.style.cssText = 'height:100%;border-radius:3px;transition:width 0.3s;background:' + barColor + ';width:' + Math.min(progress * 100, 100) + '%;';
            progressOuter.appendChild(progressInner);
            bar.appendChild(progressOuter);

            var detail = document.createElement('span');
            detail.style.cssText = 'font-size:13px;color:#6b7084;white-space:nowrap;flex-shrink:0;';
            detail.textContent = detailText;
            bar.appendChild(detail);

            return bar;
        }

        function extractCarrier(shippingMethod) {
            if (!shippingMethod) return '';
            const upper = shippingMethod.toUpperCase();
            if (upper.includes('DHL')) return 'dhl';
            if (upper.includes('POSTNL') || upper.includes('POST NL') || upper.includes('MYPARCEL')) return 'postnl';
            if (upper.includes('TNT')) return 'tnt';
            if (upper.includes('DPD')) return 'dpd';
            if (upper.includes('UPS')) return 'ups';
            return '';
        }

        function extractCarrierLabel(shippingMethod) {
            if (!shippingMethod) return '—';
            const upper = shippingMethod.toUpperCase();
            if (upper.includes('DHL')) return 'DHL';
            if (upper.includes('POSTNL') || upper.includes('POST NL') || upper.includes('MYPARCEL')) return 'PostNL';
            if (upper.includes('TNT')) return 'TNT';
            if (upper.includes('DPD')) return 'DPD';
            if (upper.includes('UPS')) return 'UPS';
            return '—';
        }

        function formatDutchDate(dateStr) {
            if (!dateStr) return '—';
            const d = new Date(dateStr);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
            const isYesterday = d.toDateString() === yesterday.toDateString();
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            if (isToday) return `Vandaag, ${hh}:${mm}`;
            if (isYesterday) return `Gisteren, ${hh}:${mm}`;
            const dag = d.getDate();
            const maanden = ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
            return `${dag} ${maanden[d.getMonth()]} ${d.getFullYear()}, ${hh}:${mm}`;
        }

        function formatCurrency(amount) {
            if (!amount || amount === '0.00') return '—';
            return '€ ' + parseFloat(amount).toLocaleString('nl-NL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ============ STORE orders with uuid for lookup ============
        let _ordersMap = {}; // uuid -> order object

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        let totalOrderCount = 0;
        let _apiLastPage = null;

        async function loadOrders(page) {
            currentPage = page || 1;
            try {
                const today = new Date().toISOString().slice(0, 10);

                if (_apiLastPage === null) {
                    const probe = await fetch(`${API_BASE}/api/orders?created_after=${today}&page=1&limit=50`, { headers: API_HEADERS });
                    if (!probe.ok) throw new Error('Orders API error');
                    const probeJson = await probe.json();
                    _apiLastPage = probeJson.lastPage || 1;
                    totalPages = _apiLastPage;
                    totalOrderCount = probeJson.total || 0;
                }

                const apiPage = Math.max(1, _apiLastPage - (currentPage - 1));
                const res = await fetch(`${API_BASE}/api/orders?created_after=${today}&page=${apiPage}&limit=50`, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Orders API error');
                const json = await res.json();
                const orders = json.data || json;
                totalPages = json.lastPage || _apiLastPage || 1;
                totalOrderCount = json.total || 0;
                _apiLastPage = totalPages;

                if (Array.isArray(orders)) {
                    orders.sort((a, b) => (b.createDate || '').localeCompare(a.createDate || ''));
                }

                renderOrders(orders);
                updatePagination();
            } catch (e) {
                console.log('Orders API not available:', e.message);
                var errTbody = document.querySelector('#ordersTable tbody');
                errTbody.textContent = '';
                var errTr = document.createElement('tr');
                var errTd = document.createElement('td');
                errTd.colSpan = 8;
                errTd.style.cssText = 'text-align:center;padding:40px;color:#c00;';
                errTd.textContent = 'Fout bij laden: ' + e.message;
                errTr.appendChild(errTd);
                errTbody.appendChild(errTr);
            }
        }

        function renderOrders(orders) {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.textContent = '';

            if (!Array.isArray(orders) || orders.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 8;
                td.style.cssText = 'text-align:center;padding:40px;color:#999;';
                td.textContent = 'Geen orders gevonden';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            orders.forEach(order => {
                // Store for later lookup
                if (order.uuid) _ordersMap[order.uuid] = order;

                const displayId = order.externalDisplayId || order.uuid.slice(0, 8);
                const customerName = [order.billingFirstName, order.billingLastName].filter(Boolean).join(' ') || '\u2014';
                const customerCity = order.billingCity || '';
                const webshop = order.webshopName || '';
                const itemCount = (order.products && order.products.length) || 0;
                const totalPaid = formatCurrency(order.totalPaid);
                const statusLabel = STATUS_MAP[order.status] || order.status || '\u2014';
                const statusClass = STATUS_CLASS_MAP[order.status] || 'pending';
                const carrierKey = extractCarrier(order.shippingMethod);
                const carrierLabel = extractCarrierLabel(order.shippingMethod);
                const dateFormatted = formatDutchDate(order.createDate);
                const uuid = order.uuid || '';

                const tr = document.createElement('tr');
                tr.dataset.status = order.status || '';
                tr.dataset.carrier = carrierKey;

                // Order ID cell
                const tdId = document.createElement('td');
                const idLink = document.createElement('a');
                idLink.className = 'order-id-link';
                idLink.title = 'Bekijk order details';
                idLink.textContent = displayId;
                idLink.addEventListener('click', function() { viewOrderByUuid(uuid); });
                tdId.appendChild(idLink);
                tr.appendChild(tdId);

                // Customer cell
                const tdCustomer = document.createElement('td');
                const custDiv = document.createElement('div');
                custDiv.className = 'customer-info';
                const custStrong = document.createElement('strong');
                custStrong.textContent = customerName;
                const custSpan = document.createElement('span');
                custSpan.textContent = webshop || customerCity;
                custDiv.appendChild(custStrong);
                custDiv.appendChild(custSpan);
                tdCustomer.appendChild(custDiv);
                tr.appendChild(tdCustomer);

                // Items cell
                tr.appendChild(createTd(itemCount + ' item' + (itemCount !== 1 ? 's' : '')));

                // Total cell
                tr.appendChild(createTd(totalPaid));

                // Status cell
                const tdStatus = document.createElement('td');
                tdStatus.appendChild(createStatusBadge(statusClass, statusLabel));
                tr.appendChild(tdStatus);

                // Carrier cell
                const tdCarrier = document.createElement('td');
                tdCarrier.appendChild(createCarrierBadge(carrierKey, carrierLabel));
                tr.appendChild(tdCarrier);

                // Date cell
                tr.appendChild(createTd(dateFormatted));

                // Actions cell (SVG icon is static/safe, no API data)
                const tdActions = document.createElement('td');
                const actionBtn = document.createElement('button');
                actionBtn.className = 'btn-icon';
                actionBtn.title = 'Bekijk details';
                actionBtn.addEventListener('click', function() { viewOrderByUuid(uuid); });
                actionBtn.innerHTML = '<svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>';
                tdActions.appendChild(actionBtn);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        function updatePagination() {
            let pagDiv = document.getElementById('pagination');
            if (!pagDiv) {
                pagDiv = document.createElement('div');
                pagDiv.id = 'pagination';
                pagDiv.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:12px;padding:20px 0;';
                document.querySelector('.card').appendChild(pagDiv);
            }
            
            if (totalPages <= 1) {
                pagDiv.innerHTML = `<span style="color:#8e93a6;font-size:14px;">Pagina 1 van 1 (${totalOrderCount.toLocaleString('nl-NL')} orders totaal)</span>`;
                return;
            }

            pagDiv.innerHTML = `
                <button onclick="loadOrders(1)" ${currentPage <= 1 ? 'disabled' : ''} style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:${currentPage <= 1 ? '#f3f4f6' : '#fff'};cursor:${currentPage <= 1 ? 'default' : 'pointer'};color:${currentPage <= 1 ? '#ccc' : '#333'}">« Eerste</button>
                <button onclick="loadOrders(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''} style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:${currentPage <= 1 ? '#f3f4f6' : '#fff'};cursor:${currentPage <= 1 ? 'default' : 'pointer'};color:${currentPage <= 1 ? '#ccc' : '#333'}">‹ Vorige</button>
                <span style="font-size:14px;color:#6b7084;">Pagina <strong>${currentPage}</strong> van <strong>${totalPages}</strong> (${totalOrderCount.toLocaleString('nl-NL')} orders)</span>
                <button onclick="loadOrders(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''} style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:${currentPage >= totalPages ? '#f3f4f6' : '#fff'};cursor:${currentPage >= totalPages ? 'default' : 'pointer'};color:${currentPage >= totalPages ? '#ccc' : '#333'}">Volgende ›</button>
                <button onclick="loadOrders(${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''} style="padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:${currentPage >= totalPages ? '#f3f4f6' : '#fff'};cursor:${currentPage >= totalPages ? 'default' : 'pointer'};color:${currentPage >= totalPages ? '#ccc' : '#333'}">Laatste »</button>
            `;
        }

        // ============ FAST COMBINED LOAD ============
        async function loadAllOrders() {
            try {
                const res = await fetch(`${API_BASE}/api/page-data/orders`, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Page data error');
                const json = await res.json();
                const d = json.data;

                // Stats uit dashboard
                if (d.dashboard && d.dashboard.orders) {
                    const totalEl = document.getElementById('totalOrders');
                    if (totalEl) totalEl.textContent = Number(d.dashboard.orders.today).toLocaleString('nl-NL');

                    const byStatus = d.dashboard.orders.by_status || {};
                    
                    // Dynamische stats met echte statussen
                    const completedEl = document.getElementById('completedOrders');
                    if (completedEl) completedEl.textContent = (byStatus.completed || 0).toLocaleString('nl-NL');

                    const rfpEl = document.getElementById('readyForPickingOrders');
                    if (rfpEl) rfpEl.textContent = (byStatus.ready_for_picking || 0).toLocaleString('nl-NL');

                    const boEl = document.getElementById('backorderOrders');
                    if (boEl) boEl.textContent = (byStatus.backorder || 0).toLocaleString('nl-NL');

                    const ohEl = document.getElementById('onHoldOrders');
                    if (ohEl) ohEl.textContent = (byStatus.on_hold || 0).toLocaleString('nl-NL');
                }

                // Orders + paginering
                if (d.orders) {
                    _apiLastPage = d.lastPage || 1;
                    totalPages = _apiLastPage;
                    totalOrderCount = d.total || 0;
                    currentPage = 1;
                    renderOrders(d.orders);
                    updatePagination();
                }
            } catch (e) {
                console.log('Combined load failed, falling back:', e.message);
                loadOrders(1);
            }
        }

        // ============ ORDER DETAIL MODAL ============
        function showModalLoading() {
            var body = document.getElementById('modalBody');
            body.textContent = '';
            var wrapper = document.createElement('div');
            wrapper.style.cssText = 'text-align:center;padding:40px;color:#999;';
            var spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            var p = document.createElement('p');
            p.style.marginTop = '12px';
            p.textContent = 'Order details laden...';
            wrapper.appendChild(spinner);
            wrapper.appendChild(p);
            body.appendChild(wrapper);
        }

        function showModalError(msg) {
            var body = document.getElementById('modalBody');
            body.textContent = '';
            var wrapper = document.createElement('div');
            wrapper.style.cssText = 'text-align:center;padding:40px;color:#c00;';
            var p = document.createElement('p');
            p.textContent = 'Fout bij laden van order: ' + msg;
            var btn = document.createElement('button');
            btn.className = 'btn btn-secondary';
            btn.style.marginTop = '16px';
            btn.textContent = 'Sluiten';
            btn.addEventListener('click', function() { closeModal(); });
            wrapper.appendChild(p);
            wrapper.appendChild(btn);
            body.appendChild(wrapper);
        }

        // Build address element with line breaks (safe)
        function createAddressValue(lines) {
            var span = document.createElement('span');
            span.className = 'detail-value';
            span.style.textAlign = 'right';
            lines.forEach(function(line, i) {
                if (i > 0) span.appendChild(document.createElement('br'));
                span.appendChild(document.createTextNode(line));
            });
            return span;
        }

        // Build a detail row with a custom value element
        function createDetailRowEl(label, valueEl) {
            var row = document.createElement('div');
            row.className = 'detail-row';
            var lbl = document.createElement('span');
            lbl.className = 'detail-label';
            lbl.textContent = label;
            row.appendChild(lbl);
            row.appendChild(valueEl);
            return row;
        }

        async function viewOrderByUuid(uuid) {
            if (!uuid) return;

            document.getElementById('modalOrderId').textContent = '';
            showModalLoading();
            document.getElementById('orderModal').classList.add('active');

            try {
                const res = await fetch(`${API_BASE}/api/orders/${uuid}`, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Kan order niet ophalen');
                const json = await res.json();
                const order = json.data;

                const displayId = order.externalDisplayId || order.uuid.slice(0, 8);
                document.getElementById('modalOrderId').textContent = displayId;

                const customerName = [order.billingFirstName, order.billingLastName].filter(Boolean).join(' ') || '\u2014';
                const shippingName = [order.shippingFirstName, order.shippingLastName].filter(Boolean).join(' ') || customerName;
                const billingAddress = [order.billingAddress, order.billingHouseNumber, order.billingHouseNumberAddition].filter(Boolean).join(' ');
                const billingCityLine = [order.billingZipcode, order.billingCity].filter(Boolean).join(' ') + (order.billingCountry ? ', ' + order.billingCountry : '');
                const shippingAddress = [order.shippingAddress, order.shippingHouseNumber, order.shippingHousenumberAddition || order.shippingHouseNumberAddition].filter(Boolean).join(' ');
                const shippingCityLine = [order.shippingZipcode, order.shippingCity].filter(Boolean).join(' ') + (order.shippingCountry ? ', ' + order.shippingCountry : '');
                const email = order.billingEmail || order.shippingEmail || '\u2014';
                const phone = order.billingPhone || order.shippingPhone || '\u2014';
                const webshop = order.webshopName || '\u2014';
                const statusLabel = STATUS_MAP[order.status] || order.status || '\u2014';
                const statusClass = STATUS_CLASS_MAP[order.status] || 'pending';
                const carrierLabel = extractCarrierLabel(order.shippingMethod);
                const carrierKey = extractCarrier(order.shippingMethod);
                const shippingMethodText = order.shippingMethod || '\u2014';
                const paymentMethod = order.paymentMethod || '\u2014';
                const shipments = order.shipments || [];
                const products = order.products || [];

                // Build modal DOM
                var modalBody = document.getElementById('modalBody');
                modalBody.textContent = '';

                // Status header
                var statusHeader = document.createElement('div');
                statusHeader.style.marginBottom = '16px';
                statusHeader.appendChild(createStatusBadge(statusClass, statusLabel));
                var webshopSpan = document.createElement('span');
                webshopSpan.style.cssText = 'margin-left:12px;font-size:13px;color:#6b7084;';
                webshopSpan.textContent = webshop;
                statusHeader.appendChild(webshopSpan);
                if (order.totalPaid && order.totalPaid !== '0.00') {
                    var totalSpan = document.createElement('span');
                    totalSpan.style.cssText = 'margin-left:12px;font-weight:600;';
                    totalSpan.textContent = formatCurrency(order.totalPaid);
                    statusHeader.appendChild(totalSpan);
                }
                modalBody.appendChild(statusHeader);

                // SLA status bar
                var slaBar = createSLABar(order);
                if (slaBar) modalBody.appendChild(slaBar);

                // Detail grid
                var detailGrid = document.createElement('div');
                detailGrid.className = 'detail-grid';

                // Left: Klantgegevens
                var custSection = document.createElement('div');
                custSection.className = 'detail-section';
                var custH3 = document.createElement('h3');
                custH3.textContent = 'Klantgegevens';
                custSection.appendChild(custH3);
                custSection.appendChild(createDetailRow('Naam', customerName));
                if (order.billingCompany) {
                    custSection.appendChild(createDetailRow('Bedrijf', order.billingCompany));
                }
                custSection.appendChild(createDetailRowEl('Adres', createAddressValue([billingAddress, billingCityLine])));
                // Email with link
                var emailVal = document.createElement('span');
                emailVal.className = 'detail-value';
                var emailLink = document.createElement('a');
                emailLink.href = 'mailto:' + email;
                emailLink.style.color = '#2563eb';
                emailLink.textContent = email;
                emailVal.appendChild(emailLink);
                custSection.appendChild(createDetailRowEl('E-mail', emailVal));
                if (phone !== '\u2014') {
                    custSection.appendChild(createDetailRow('Telefoon', phone));
                }
                custSection.appendChild(createDetailRow('Betaling', paymentMethod));
                detailGrid.appendChild(custSection);

                // Right: Verzending
                var shipSection = document.createElement('div');
                shipSection.className = 'detail-section';
                var shipH3 = document.createElement('h3');
                shipH3.textContent = 'Verzending';
                shipSection.appendChild(shipH3);
                shipSection.appendChild(createDetailRow('Methode', shippingMethodText));
                // Carrier with badge
                var carrierVal = document.createElement('span');
                carrierVal.className = 'detail-value';
                carrierVal.appendChild(createCarrierBadge(carrierKey, carrierLabel));
                shipSection.appendChild(createDetailRowEl('Carrier', carrierVal));

                // Verwachte levertijd (geschat op basis van carrier)
                if (order.createDate && ['shipped', 'completed', 'delivered'].indexOf(order.status) < 0) {
                    var createMs2 = new Date(order.createDate).getTime();
                    var slaMs2 = 24 * 60 * 60 * 1000;
                    var deliveryDays = carrierKey === 'postnl' ? 1 : carrierKey === 'dhl' ? 1 : carrierKey === 'dpd' ? 2 : carrierKey === 'ups' ? 2 : 2;
                    var estDate = new Date(createMs2 + slaMs2 + (deliveryDays * 24 * 60 * 60 * 1000));
                    var estStr = estDate.toLocaleDateString('nl-NL', { weekday: 'short', day: 'numeric', month: 'short' });
                    shipSection.appendChild(createDetailRow('Verwachte levering', estStr));
                }

                // Track & trace
                var trackVal = document.createElement('span');
                trackVal.className = 'detail-value';
                if (shipments.length > 0) {
                    shipments.forEach(function(s) {
                        var trackDiv = document.createElement('div');
                        trackDiv.style.marginBottom = '4px';
                        var code = s.trackTraceCode || '\u2014';
                        var url = s.trackTraceUrl || '#';
                        if (url !== '#') {
                            var a = document.createElement('a');
                            a.href = url;
                            a.target = '_blank';
                            a.className = 'link';
                            a.style.color = '#2563eb';
                            a.textContent = code;
                            trackDiv.appendChild(a);
                        } else {
                            trackDiv.textContent = code;
                        }
                        trackVal.appendChild(trackDiv);
                    });
                } else {
                    var noTrack = document.createElement('span');
                    noTrack.style.color = '#999';
                    noTrack.textContent = 'Nog geen verzending';
                    trackVal.appendChild(noTrack);
                }
                shipSection.appendChild(createDetailRowEl('Track & Trace', trackVal));
                shipSection.appendChild(createDetailRowEl('Verzendadres', createAddressValue([shippingName, shippingAddress, shippingCityLine])));
                detailGrid.appendChild(shipSection);
                modalBody.appendChild(detailGrid);

                // Products table
                var prodSection = document.createElement('div');
                prodSection.className = 'detail-section';
                prodSection.style.marginTop = '24px';
                var prodH3 = document.createElement('h3');
                prodH3.textContent = 'Orderregels (' + products.length + ' product' + (products.length !== 1 ? 'en' : '') + ')';
                prodSection.appendChild(prodH3);
                var prodTable = document.createElement('table');
                prodTable.className = 'detail-table';
                var prodThead = document.createElement('thead');
                var prodHeadRow = document.createElement('tr');
                ['SKU', 'Product', 'Aantal', 'Gepickt', 'Prijs'].forEach(function(h, i) {
                    var th = document.createElement('th');
                    th.textContent = h;
                    if (i === 2 || i === 3) th.style.textAlign = 'center';
                    if (i === 4) th.style.textAlign = 'right';
                    prodHeadRow.appendChild(th);
                });
                prodThead.appendChild(prodHeadRow);
                prodTable.appendChild(prodThead);
                var prodTbody = document.createElement('tbody');
                if (products.length === 0) {
                    var emptyTr = document.createElement('tr');
                    var emptyTd = document.createElement('td');
                    emptyTd.colSpan = 5;
                    emptyTd.style.cssText = 'text-align:center;color:#999;padding:20px;';
                    emptyTd.textContent = 'Geen producten';
                    emptyTr.appendChild(emptyTd);
                    prodTbody.appendChild(emptyTr);
                } else {
                    products.forEach(function(p) {
                        var picked = p.pickedQuantity || 0;
                        var qty = p.productQuantity || 0;
                        var tr = document.createElement('tr');
                        var tdSku = document.createElement('td');
                        var codeSku = document.createElement('code');
                        codeSku.textContent = p.sku || '\u2014';
                        tdSku.appendChild(codeSku);
                        tr.appendChild(tdSku);
                        tr.appendChild(createTd(p.productName || '\u2014'));
                        tr.appendChild(createTd(String(qty), { style: 'text-align:center;' }));
                        var tdPicked = document.createElement('td');
                        tdPicked.style.textAlign = 'center';
                        var pickedSpan = document.createElement('span');
                        pickedSpan.className = picked >= qty ? 'green' : (picked > 0 ? 'orange' : '');
                        pickedSpan.textContent = String(picked);
                        tdPicked.appendChild(pickedSpan);
                        tr.appendChild(tdPicked);
                        tr.appendChild(createTd(formatCurrency(p.productPrice), { style: 'text-align:right;' }));
                        prodTbody.appendChild(tr);
                    });
                }
                prodTable.appendChild(prodTbody);
                prodSection.appendChild(prodTable);
                modalBody.appendChild(prodSection);

                // Timeline
                var tlSection = document.createElement('div');
                tlSection.className = 'detail-section';
                tlSection.style.marginTop = '24px';
                var tlH3 = document.createElement('h3');
                tlH3.textContent = 'Timeline';
                tlSection.appendChild(tlH3);
                var tlDiv = document.createElement('div');
                tlDiv.className = 'timeline';

                tlDiv.appendChild(createTimelineItem('Order ontvangen', formatDutchDate(order.createDate), 'completed'));
                if (order.finishDate) {
                    tlDiv.appendChild(createTimelineItem('Verwerking afgerond', formatDutchDate(order.finishDate), 'completed'));
                }
                if (order.shippedDate) {
                    tlDiv.appendChild(createTimelineItem('Verzonden', formatDutchDate(order.shippedDate) + (carrierLabel !== '\u2014' ? ' \u2014 ' + carrierLabel : ''), 'completed'));
                }
                if (shipments.length > 0) {
                    shipments.forEach(function(s) {
                        if (s.createDate && !order.shippedDate) {
                            tlDiv.appendChild(createTimelineItem('Verzending aangemaakt', formatDutchDate(s.createDate), 'completed'));
                        }
                    });
                }
                if (order.status === 'completed' && !order.shippedDate) {
                    tlDiv.appendChild(createTimelineItem('Afgerond', order.finishDate ? formatDutchDate(order.finishDate) : '\u2014', 'completed'));
                }
                var statusOrder = ['ready_for_picking', 'processing', 'picked', 'packed', 'shipped', 'completed', 'delivered'];
                var statusTimeline = {
                    'ready_for_picking': 'Klaar voor picking',
                    'processing': 'In verwerking',
                    'picked': 'Gepickt',
                    'packed': 'Ingepakt',
                    'shipped': 'Verzonden',
                    'completed': 'Afgerond',
                    'delivered': 'Afgeleverd'
                };
                var currentIdx = statusOrder.indexOf(order.status);
                if (currentIdx >= 0 && currentIdx < statusOrder.length - 1) {
                    var nextStatus = statusOrder[currentIdx + 1];
                    if (statusTimeline[nextStatus]) {
                        tlDiv.appendChild(createTimelineItem(statusTimeline[nextStatus], 'Verwacht', 'active'));
                    }
                }
                tlSection.appendChild(tlDiv);
                modalBody.appendChild(tlSection);

                // Customer note
                if (order.customerNote) {
                    var noteDiv = document.createElement('div');
                    noteDiv.style.cssText = 'margin-top:20px;padding:16px;background:#fffbeb;border-radius:10px;border:1px solid #fde68a;';
                    var noteStrong = document.createElement('strong');
                    noteStrong.style.cssText = 'font-size:13px;color:#92400e;';
                    noteStrong.textContent = 'Klantopmerking:';
                    var noteP = document.createElement('p');
                    noteP.style.cssText = 'margin-top:4px;font-size:14px;color:#78350f;';
                    noteP.textContent = order.customerNote;
                    noteDiv.appendChild(noteStrong);
                    noteDiv.appendChild(noteP);
                    modalBody.appendChild(noteDiv);
                }

                // Internal comment
                if (order.internComment) {
                    var commentDiv = document.createElement('div');
                    commentDiv.style.cssText = 'margin-top:12px;padding:16px;background:#f0f4ff;border-radius:10px;border:1px solid #bfdbfe;';
                    var commentStrong = document.createElement('strong');
                    commentStrong.style.cssText = 'font-size:13px;color:#1e40af;';
                    commentStrong.textContent = 'Interne opmerking:';
                    var commentP = document.createElement('p');
                    commentP.style.cssText = 'margin-top:4px;font-size:14px;color:#1e3a5f;';
                    commentP.textContent = order.internComment;
                    commentDiv.appendChild(commentStrong);
                    commentDiv.appendChild(commentP);
                    modalBody.appendChild(commentDiv);
                }
            } catch (e) {
                showModalError(e.message);
            }
        }

        // Check for search param from global search (Feature 8)
        const urlParams = new URLSearchParams(window.location.search);
        const searchParam = urlParams.get('search');
        if (searchParam) {
            document.getElementById('searchInput').value = searchParam;
        }

        // Initial load
        loadAllOrders();

        // Apply search filter after load if present
        if (searchParam) {
            setTimeout(() => filterOrders(), 1500);
        }

        // ============================================
        // EXISTING FUNCTIONS
        // ============================================
        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const carrier = document.getElementById('carrierFilter').value;
            const rows = document.querySelectorAll('#ordersTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowStatus = row.dataset.status;
                const rowCarrier = row.dataset.carrier;
                
                const matchSearch = text.includes(search);
                const matchStatus = !status || rowStatus === status;
                const matchCarrier = !carrier || rowCarrier === carrier;
                
                row.style.display = matchSearch && matchStatus && matchCarrier ? '' : 'none';
            });
        }

        function closeModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('orderModal').classList.remove('active');
            }
        }

        function exportOrders() {
            const rows = document.querySelectorAll('#ordersTable tbody tr');
            if (!rows.length) { alert('Geen data om te exporteren.'); return; }
            const headers = ['Order ID', 'Klant', 'Items', 'Totaal', 'Status', 'Carrier', 'Datum'];
            const csvRows = [headers.join(';')];
            rows.forEach(row => {
                if (row.style.display === 'none') return;
                const cells = row.querySelectorAll('td');
                if (cells.length < 7) return;
                const vals = [
                    (cells[0].textContent || '').trim().replace('#',''),
                    (cells[1].textContent || '').trim().replace(/\n/g, ' '),
                    (cells[2].textContent || '').trim(),
                    (cells[3].textContent || '').trim(),
                    (cells[4].textContent || '').trim(),
                    (cells[5].textContent || '').trim(),
                    (cells[6].textContent || '').trim()
                ].map(v => '"' + v.replace(/"/g, '""') + '"');
                csvRows.push(vals.join(';'));
            });
            const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'orders_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
<script src="nav.js"></script>
<script src="ai-insights.js"></script>
</body>
</html>
