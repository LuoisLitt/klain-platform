<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verzendingen — Dura Fulfilment</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .loading-spinner {
            width: 24px; height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .order-link {
            color: #2563eb;
            cursor: pointer;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-weight: 600;
            text-decoration: none;
        }
        .order-link:hover { text-decoration: underline; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .detail-section h3 { font-size: 14px; font-weight: 600; color: #8e93a6; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f2; font-size: 14px; }
        .detail-label { color: #6b7084; }
        .detail-value { font-weight: 500; text-align: right; }
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .detail-table th { text-align: left; padding: 10px 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #8e93a6; border-bottom: 2px solid #e8e8ed; }
        .detail-table td { padding: 12px; font-size: 14px; border-bottom: 1px solid #f0f0f2; }
        @media (max-width: 768px) { .detail-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <script src="auth.js"></script>
    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html" class="logo">Dura <span>Fulfilment</span></a>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="orders.html">Orders</a></li>
                    <li><a href="voorraad.html">Voorraad</a></li>
                    <li><a href="verzendingen.html" class="active">Verzendingen</a></li>
                    <li><a href="rapportages.html">Rapportages</a></li>
                </ul>
            </div>
            <div class="nav-right">
                <div class="global-search" style="position:relative;">
                    <input type="text" id="globalSearch" placeholder="Zoek order, klant, SKU..."
                        style="width:220px;padding:8px 12px 8px 34px;border:1px solid #d2d2d7;border-radius:8px;font-size:13px;font-family:inherit;background:var(--gray-light);outline:none;transition:all 0.2s;"
                        onfocus="this.style.width='300px';this.style.borderColor='var(--blue)';this.style.background='#fff'"
                        onblur="this.style.width='220px';this.style.borderColor='#d2d2d7';this.style.background='var(--gray-light)'"
                        onkeydown="if(event.key==='Enter'){var q=this.value.trim();if(q)window.location.href='orders.html?search='+encodeURIComponent(q);}">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:#8e93a6;pointer-events:none;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </div>
                <a href="warehouse.html" class="btn-warehouse" title="Warehouse Display">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h17.25c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    Warehouse Display
                </a>
                <div class="nav-user">
                    <div class="user-avatar" id="userAvatar">DF</div>
                    <span class="user-name" id="userName">Demo Account</span>
                </div>
                <button class="hamburger" aria-label="Menu" aria-expanded="false">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Header -->
        <header class="page-header">
            <div class="header-title">
                <h1>Verzendingen</h1>
                <p>Track & trace en carrier overzicht</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportShipments()">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Exporteer
                </button>
            </div>
        </header>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-value blue" id="statShipTotal">—</span>
                <span class="stat-label">Verzendingen vandaag</span>
            </div>
            <div class="stat-box">
                <span class="stat-value green" id="statShipDelivered">—</span>
                <span class="stat-label">Afgeleverd</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="statShipTransit">—</span>
                <span class="stat-label">Onderweg</span>
            </div>
            <div class="stat-box">
                <span class="stat-value orange" id="statShipOther">—</span>
                <span class="stat-label">Overig</span>
            </div>
        </div>

        <!-- Carrier Performance (live) -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">Carrier Verdeling</div>
                    <div class="card-subtitle">Overzicht per vervoerder (live)</div>
                </div>
            </div>
            <div id="carrierCards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div style="padding: 24px; background: var(--gray-light); border-radius: 12px; text-align:center; color:#999;">
                    <div class="loading-spinner"></div>
                    <div style="margin-top:8px;">Laden...</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="search-box">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" placeholder="Zoek op track & trace, order ID of klantnaam..." id="searchInput" onkeyup="filterShipments()">
            </div>
            <div class="filter-group">
                <select id="statusFilter" onchange="filterShipments()">
                    <option value="">Alle statussen</option>
                    <option value="transit">Onderweg</option>
                    <option value="delivered">Afgeleverd</option>
                    <option value="problem">Probleem</option>
                </select>
                <select id="carrierFilter" onchange="filterShipments()">
                    <option value="">Alle carriers</option>
                    <option value="postnl">PostNL</option>
                    <option value="dhl">DHL</option>
                    <option value="dpd">DPD</option>
                </select>
                <input type="date" id="dateFilter" onchange="filterShipments()">
            </div>
        </div>

        <!-- Shipments Table -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">Alle Verzendingen</div>
                    <div class="card-subtitle">Vandaag</div>
                </div>
            </div>
            <table class="data-table" id="shipmentsTable">
                <thead>
                    <tr>
                        <th>Track & Trace</th>
                        <th>Order</th>
                        <th>Klant</th>
                        <th>Carrier</th>
                        <th>Status</th>
                        <th>Verzonden</th>
                        <th>Afgeleverd</th>
                    </tr>
                </thead>
                <tbody id="shipmentBody">
                    <tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">
                        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                            <div class="loading-spinner"></div>
                            Bezig met laden...
                        </div>
                    </td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Order Detail Modal (voor klikken op order nummer) -->
    <div class="modal-overlay" id="orderModal" onclick="closeOrderModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Order <span id="modalOrderId"></span></h2>
                <button class="btn-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div style="text-align:center;padding:40px;color:#999;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top:12px;">Order details laden...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.DURA_API_BASE;
        const API_HEADERS = window.DURA_API_HEADERS;

        const STATUS_MAP = {
            'open': 'Nieuw',
            'processing': 'In verwerking',
            'picked': 'Gepickt',
            'packed': 'Ingepakt',
            'shipped': 'Verzonden',
            'completed': 'Afgerond',
            'delivered': 'Afgeleverd',
            'ready_for_picking': 'Klaar voor picking',
            'backorder': 'Backorder',
            'on_hold': 'On hold'
        };

        const STATUS_CLASS_MAP = {
            'open': 'pending',
            'processing': 'picking',
            'picked': 'picking',
            'packed': 'packed',
            'shipped': 'shipped',
            'completed': 'delivered',
            'delivered': 'delivered',
            'ready_for_picking': 'pending',
            'backorder': 'critical',
            'on_hold': 'processing'
        };

        const SLA_HOURS = 24;

        function createSLABar(order) {
            if (!order.createDate) return null;

            var createTime = new Date(order.createDate).getTime();
            var slaMs = SLA_HOURS * 60 * 60 * 1000;
            var slaDeadline = createTime + slaMs;

            var endTime;
            var isResolved = false;
            if (order.shippedDate) {
                endTime = new Date(order.shippedDate).getTime();
                isResolved = true;
            } else if (order.finishDate) {
                endTime = new Date(order.finishDate).getTime();
                isResolved = true;
            } else {
                endTime = Date.now();
            }

            var elapsed = endTime - createTime;
            var isOnTime = elapsed <= slaMs;
            var progress = Math.min(elapsed / slaMs, 1.5);

            var bar = document.createElement('div');
            bar.style.cssText = 'display:flex;align-items:center;gap:16px;padding:14px 18px;border-radius:12px;margin-bottom:16px;';

            var badgeColor, badgeText, detailText, barColor;

            if (isResolved && isOnTime) {
                bar.style.background = '#f0fdf4';
                bar.style.border = '1px solid rgba(22,163,74,0.15)';
                badgeColor = '#16a34a';
                badgeText = 'Op tijd';
                var hrs = Math.floor(elapsed / 3600000);
                var mins = Math.floor((elapsed % 3600000) / 60000);
                detailText = 'Verwerkt in ' + hrs + 'u ' + mins + 'min';
                barColor = '#16a34a';
            } else if (!isResolved && isOnTime) {
                bar.style.background = '#fff7ed';
                bar.style.border = '1px solid rgba(234,88,12,0.15)';
                badgeColor = '#ea580c';
                badgeText = 'In behandeling';
                var remaining = slaDeadline - endTime;
                var remHrs = Math.floor(remaining / 3600000);
                var remMins = Math.floor((remaining % 3600000) / 60000);
                detailText = 'Nog ' + remHrs + 'u ' + remMins + 'min binnen SLA';
                barColor = '#ea580c';
            } else {
                bar.style.background = '#fef2f2';
                bar.style.border = '1px solid rgba(220,38,38,0.15)';
                badgeColor = '#dc2626';
                badgeText = 'Vertraagd';
                var overMs = elapsed - slaMs;
                var overHrs = Math.floor(overMs / 3600000);
                var overMins = Math.floor((overMs % 3600000) / 60000);
                detailText = overHrs + 'u ' + overMins + 'min over SLA';
                if (isResolved) detailText = 'Verwerkt ' + detailText;
                barColor = '#dc2626';
            }

            var badge = document.createElement('span');
            badge.style.cssText = 'padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;color:white;background:' + badgeColor + ';flex-shrink:0;';
            badge.textContent = badgeText;
            bar.appendChild(badge);

            var progressOuter = document.createElement('div');
            progressOuter.style.cssText = 'flex:1;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;';
            var progressInner = document.createElement('div');
            progressInner.style.cssText = 'height:100%;border-radius:3px;transition:width 0.3s;background:' + barColor + ';width:' + Math.min(progress * 100, 100) + '%;';
            progressOuter.appendChild(progressInner);
            bar.appendChild(progressOuter);

            var detail = document.createElement('span');
            detail.style.cssText = 'font-size:13px;color:#6b7084;white-space:nowrap;flex-shrink:0;';
            detail.textContent = detailText;
            bar.appendChild(detail);

            return bar;
        }

        function filterShipments() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const carrier = document.getElementById('carrierFilter').value;
            const rows = document.querySelectorAll('#shipmentsTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowStatus = row.dataset.status;
                const rowCarrier = row.dataset.carrier;
                
                const matchSearch = text.includes(search);
                const matchStatus = !status || rowStatus === status;
                const matchCarrier = !carrier || rowCarrier === carrier;
                
                row.style.display = matchSearch && matchStatus && matchCarrier ? '' : 'none';
            });
        }

        function closeOrderModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('orderModal').classList.remove('active');
            }
        }

        function exportShipments() {
            const rows = document.querySelectorAll('#shipmentsTable tbody tr');
            if (!rows.length) { alert('Geen data om te exporteren.'); return; }
            const headers = ['Track & Trace', 'Order', 'Klant', 'Carrier', 'Status', 'Verzonden', 'Afgeleverd'];
            const csvRows = [headers.join(';')];
            rows.forEach(row => {
                if (row.style.display === 'none') return;
                const cells = row.querySelectorAll('td');
                if (cells.length < 7) return;
                const vals = Array.from(cells).map(c => '"' + (c.textContent || '').trim().replace(/"/g, '""').replace(/\n/g, ' ') + '"');
                csvRows.push(vals.join(';'));
            });
            const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'verzendingen_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeOrderModal();
        });

        // ============ LIVE API INTEGRATION ============
        const shipmentStatusMap = {
            'pending_registered': { label: 'Aangemeld', class: 'processing' },
            'pending': { label: 'Wacht', class: 'processing' },
            'shipped': { label: 'Onderweg', class: 'shipped' },
            'in_transit': { label: 'Onderweg', class: 'shipped' },
            'out_for_delivery': { label: 'Bezorging', class: 'shipped' },
            'delivered_at_recipient': { label: 'Afgeleverd', class: 'delivered' },
            'delivered': { label: 'Afgeleverd', class: 'delivered' },
            'returned': { label: 'Retour', class: 'critical' },
            'problem': { label: 'Probleem', class: 'critical' },
            '': { label: 'Verwerkt', class: 'processing' },
            'no_update_supported': { label: 'Verwerkt', class: 'processing' }
        };

        function carrierNameToClass(name) {
            const lower = (name || '').toLowerCase();
            if (lower.includes('dhl')) return 'dhl';
            if (lower.includes('postnl')) return 'postnl';
            if (lower.includes('dpd')) return 'dpd';
            return 'postnl';
        }

        function extractCarrier(shipment) {
            const method = (shipment.shippingMethod || shipment.shippingCarrier || shipment.carrier || '').toLowerCase();
            if (method.includes('dhl')) return { name: 'DHL', class: 'dhl' };
            if (method.includes('postnl') || method.includes('tnt')) return { name: 'PostNL', class: 'postnl' };
            if (method.includes('dpd')) return { name: 'DPD', class: 'dpd' };
            if (method.includes('ups')) return { name: 'UPS', class: 'postnl' };
            return { name: method.substring(0, 20) || 'Onbekend', class: 'postnl' };
        }

        function extractCarrierLabel(shippingMethod) {
            if (!shippingMethod) return '—';
            const upper = shippingMethod.toUpperCase();
            if (upper.includes('DHL')) return 'DHL';
            if (upper.includes('POSTNL') || upper.includes('POST NL') || upper.includes('MYPARCEL')) return 'PostNL';
            if (upper.includes('TNT')) return 'TNT';
            if (upper.includes('DPD')) return 'DPD';
            if (upper.includes('UPS')) return 'UPS';
            return '—';
        }

        function formatDateNL(dateStr) {
            if (!dateStr) return '—';
            const d = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            const dateOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const time = d.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

            if (dateOnly.getTime() === today.getTime()) return `Vandaag, ${time}`;
            if (dateOnly.getTime() === yesterday.getTime()) return `Gisteren, ${time}`;
            return d.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric' }) + `, ${time}`;
        }

        function formatCurrency(amount) {
            if (!amount || amount === '0.00') return '—';
            return '€ ' + parseFloat(amount).toLocaleString('nl-NL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Pagination state
        let shipCurrentPage = 1;
        let shipTotalPages = 1;
        let shipTotalCount = 0;
        let _shipApiLastPage = null;

        async function loadShipments(page) {
            shipCurrentPage = page || 1;
            try {
                const today = new Date().toISOString().slice(0, 10);

                if (_shipApiLastPage === null) {
                    const probe = await fetch(`${API_BASE}/api/shipments?created_after=${today}&page=1&limit=50`, { headers: API_HEADERS });
                    if (!probe.ok) throw new Error('Shipments API error');
                    const probeJson = await probe.json();
                    _shipApiLastPage = probeJson.lastPage || 1;
                    shipTotalPages = _shipApiLastPage;
                    shipTotalCount = probeJson.total || 0;
                }

                const apiPage = Math.max(1, _shipApiLastPage - (shipCurrentPage - 1));
                const res = await fetch(`${API_BASE}/api/shipments?created_after=${today}&page=${apiPage}&limit=50`, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Shipments API error');
                const json = await res.json();
                const shipments = json.data || [];
                shipTotalPages = json.lastPage || _shipApiLastPage || 1;
                shipTotalCount = json.total || 0;
                _shipApiLastPage = shipTotalPages;

                shipments.sort((a, b) => (b.createDate || '').localeCompare(a.createDate || ''));
                renderShipments(shipments);
                updateShipPagination();
            } catch (e) {
                console.log('Shipments API niet beschikbaar:', e.message);
            }
        }

        function renderShipments(shipments) {
            const tbody = document.querySelector('#shipmentsTable tbody');
            tbody.textContent = '';

            if (!shipments || !shipments.length) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.style.cssText = 'text-align:center;padding:40px;color:#999;';
                td.textContent = 'Geen verzendingen gevonden';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            shipments.forEach(s => {
                const status = shipmentStatusMap[s.status] || { label: s.status || 'Onbekend', class: 'processing' };
                const carrier = extractCarrier(s);
                const trackCode = s.trackTraceCode || s.trackTrace || s.externalId || '\u2014';
                const trackUrl = s.trackTraceUrl || '#';
                const orderId = s.referenceText || s.externalId || '\u2014';
                const klant = [s.shippingFirstName, s.shippingLastName].filter(Boolean).join(' ') || '\u2014';
                const city = s.shippingCity ? ', ' + s.shippingCity : '';
                const orderUuid = (s.linkedOrder && s.linkedOrder.uuid) ? s.linkedOrder.uuid : '';

                const tr = document.createElement('tr');
                tr.dataset.status = s.status;
                tr.dataset.carrier = carrier.class;

                // Track & Trace cell
                const tdTrack = document.createElement('td');
                if (trackUrl !== '#') {
                    const a = document.createElement('a');
                    a.href = trackUrl;
                    a.target = '_blank';
                    a.className = 'link';
                    a.textContent = trackCode;
                    tdTrack.appendChild(a);
                } else {
                    tdTrack.textContent = trackCode;
                }

                // Order cell
                const tdOrder = document.createElement('td');
                if (orderUuid) {
                    const a = document.createElement('a');
                    a.className = 'order-link';
                    a.title = 'Bekijk order details';
                    a.textContent = orderId;
                    a.addEventListener('click', function() { viewOrderFromShipment(orderUuid); });
                    tdOrder.appendChild(a);
                } else {
                    const span = document.createElement('span');
                    span.className = 'order-id';
                    span.textContent = orderId;
                    tdOrder.appendChild(span);
                }

                // Klant cell
                const tdKlant = document.createElement('td');
                tdKlant.textContent = klant + city;

                // Carrier cell
                const tdCarrier = document.createElement('td');
                const carrierBadge = document.createElement('span');
                carrierBadge.className = 'carrier-badge ' + carrier.class;
                carrierBadge.textContent = carrier.name;
                tdCarrier.appendChild(carrierBadge);

                // Status cell
                const tdStatus = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge ' + status.class;
                const dot = document.createElement('span');
                dot.className = 'status-dot';
                statusBadge.appendChild(dot);
                statusBadge.appendChild(document.createTextNode(status.label));
                tdStatus.appendChild(statusBadge);

                // Verzonden cell
                const tdVerzonden = document.createElement('td');
                tdVerzonden.textContent = formatDateNL(s.createDate);

                // Afgeleverd cell
                const tdAfgeleverd = document.createElement('td');
                tdAfgeleverd.textContent = s.deliveredDate ? formatDateNL(s.deliveredDate) + ' \u2713' : '\u2014';

                tr.appendChild(tdTrack);
                tr.appendChild(tdOrder);
                tr.appendChild(tdKlant);
                tr.appendChild(tdCarrier);
                tr.appendChild(tdStatus);
                tr.appendChild(tdVerzonden);
                tr.appendChild(tdAfgeleverd);
                tbody.appendChild(tr);
            });
        }

        function createPagButton(text, page, disabled) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.disabled = disabled;
            btn.style.cssText = 'padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:' + (disabled ? '#f3f4f6' : '#fff') + ';cursor:' + (disabled ? 'default' : 'pointer') + ';color:' + (disabled ? '#ccc' : '#333');
            if (!disabled) btn.addEventListener('click', function() { loadShipments(page); });
            return btn;
        }

        function updateShipPagination() {
            let pagDiv = document.getElementById('shipPagination');
            if (!pagDiv) {
                pagDiv = document.createElement('div');
                pagDiv.id = 'shipPagination';
                pagDiv.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:12px;padding:20px 0;';
                document.querySelector('#shipmentsTable').closest('.card').appendChild(pagDiv);
            }

            pagDiv.textContent = '';

            if (shipTotalPages <= 1) {
                const span = document.createElement('span');
                span.style.cssText = 'color:#8e93a6;font-size:14px;';
                span.textContent = 'Pagina 1 van 1 (' + shipTotalCount.toLocaleString('nl-NL') + ' verzendingen)';
                pagDiv.appendChild(span);
                return;
            }

            const p = shipCurrentPage;
            const tp = shipTotalPages;

            pagDiv.appendChild(createPagButton('\u00AB Eerste', 1, p <= 1));
            pagDiv.appendChild(createPagButton('\u2039 Vorige', p - 1, p <= 1));

            const info = document.createElement('span');
            info.style.cssText = 'font-size:14px;color:#6b7084;';
            info.appendChild(document.createTextNode('Pagina '));
            const bold1 = document.createElement('strong');
            bold1.textContent = p;
            info.appendChild(bold1);
            info.appendChild(document.createTextNode(' van '));
            const bold2 = document.createElement('strong');
            bold2.textContent = tp;
            info.appendChild(bold2);
            info.appendChild(document.createTextNode(' (' + shipTotalCount.toLocaleString('nl-NL') + ' verzendingen)'));
            pagDiv.appendChild(info);

            pagDiv.appendChild(createPagButton('Volgende \u203A', p + 1, p >= tp));
            pagDiv.appendChild(createPagButton('Laatste \u00BB', tp, p >= tp));
        }

        // ============ FAST COMBINED LOAD ============
        async function loadAllShipments() {
            try {
                const res = await fetch(`${API_BASE}/api/page-data/shipments`, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Page data error');
                const json = await res.json();
                const d = json.data;

                // Stats
                const total = d.total || 0;
                document.getElementById('statShipTotal').textContent = total.toLocaleString('nl-NL');

                // Paginering setup
                _shipApiLastPage = d.lastPage || 1;
                shipTotalPages = _shipApiLastPage;
                shipTotalCount = d.total || 0;
                shipCurrentPage = 1;

                if (d.shipments && d.shipments.length > 0) {
                    // Stats uit shipments data
                    let delivered = 0, transit = 0;
                    d.shipments.forEach(s => {
                        if (s.status === 'delivered_at_recipient' || s.status === 'delivered') delivered++;
                        if (s.status === 'shipped' || s.status === 'in_transit' || s.status === 'out_for_delivery' || s.status === 'registered') transit++;
                    });
                    document.getElementById('statShipDelivered').textContent = delivered;
                    document.getElementById('statShipTransit').textContent = transit;
                    document.getElementById('statShipOther').textContent = Math.max(0, d.shipments.length - delivered - transit);

                    // Carrier cards — gebruik dashboard stats (alle shipments) indien beschikbaar
                    const dashCarriers = d.dashboard && d.dashboard.shipments && d.dashboard.shipments.top_carriers;
                    let sorted;
                    let carrierTotal;
                    if (dashCarriers && dashCarriers.length > 0) {
                        sorted = dashCarriers.map(c => [c.name, { count: c.count, class: carrierNameToClass(c.name) }]);
                        carrierTotal = sorted.reduce((sum, e) => sum + e[1].count, 0);
                    } else {
                        const carriers = {};
                        d.shipments.forEach(s => {
                            const c = extractCarrier(s);
                            if (!carriers[c.name]) carriers[c.name] = { count: 0, class: c.class };
                            carriers[c.name].count++;
                        });
                        sorted = Object.entries(carriers).sort((a, b) => b[1].count - a[1].count);
                        carrierTotal = d.shipments.length;
                    }
                    const carrierCards = document.getElementById('carrierCards');
                    const cols = Math.min(sorted.length, 4);
                    carrierCards.style.gridTemplateColumns = 'repeat(' + cols + ', 1fr)';
                    carrierCards.textContent = '';
                    sorted.forEach(([name, info]) => {
                        const pct = carrierTotal > 0 ? ((info.count / carrierTotal) * 100).toFixed(1) : '0.0';
                        const card = document.createElement('div');
                        card.style.cssText = 'padding: 24px; background: var(--gray-light); border-radius: 12px;';

                        const topRow = document.createElement('div');
                        topRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
                        const badge = document.createElement('span');
                        badge.className = 'carrier-badge ' + info.class;
                        badge.style.cssText = 'font-size: 14px; padding: 6px 12px;';
                        badge.textContent = name;
                        const pctSpan = document.createElement('span');
                        pctSpan.style.cssText = 'font-size: 24px; font-weight: 700; color: var(--blue);';
                        pctSpan.textContent = pct + '%';
                        topRow.appendChild(badge);
                        topRow.appendChild(pctSpan);

                        const bottomRow = document.createElement('div');
                        const countDiv = document.createElement('div');
                        countDiv.style.cssText = 'font-size: 20px; font-weight: 700;';
                        countDiv.textContent = info.count;
                        const labelDiv = document.createElement('div');
                        labelDiv.style.cssText = 'font-size: 12px; color: var(--gray-medium);';
                        labelDiv.textContent = 'Zendingen';
                        bottomRow.appendChild(countDiv);
                        bottomRow.appendChild(labelDiv);

                        card.appendChild(topRow);
                        card.appendChild(bottomRow);
                        carrierCards.appendChild(card);
                    });

                    // Tabel
                    renderShipments(d.shipments);
                }
                updateShipPagination();
            } catch (e) {
                console.log('Combined load failed, falling back:', e.message);
                loadShipments(1);
            }
        }

        // ============ ORDER DETAIL MODAL ============
        function showModalLoading() {
            const body = document.getElementById('modalBody');
            body.textContent = '';
            const wrap = document.createElement('div');
            wrap.style.cssText = 'text-align:center;padding:40px;color:#999;';
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            const p = document.createElement('p');
            p.style.marginTop = '12px';
            p.textContent = 'Order details laden...';
            wrap.appendChild(spinner);
            wrap.appendChild(p);
            body.appendChild(wrap);
        }

        function showModalError(msg) {
            const body = document.getElementById('modalBody');
            body.textContent = '';
            const wrap = document.createElement('div');
            wrap.style.cssText = 'text-align:center;padding:40px;color:#c00;';
            const p = document.createElement('p');
            p.textContent = 'Fout bij laden van order: ' + msg;
            const btn = document.createElement('button');
            btn.className = 'btn btn-secondary';
            btn.style.marginTop = '16px';
            btn.textContent = 'Sluiten';
            btn.addEventListener('click', function() { closeOrderModal(); });
            wrap.appendChild(p);
            wrap.appendChild(btn);
            body.appendChild(wrap);
        }

        function createDetailRow(label, valueText) {
            const row = document.createElement('div');
            row.className = 'detail-row';
            const lbl = document.createElement('span');
            lbl.className = 'detail-label';
            lbl.textContent = label;
            const val = document.createElement('span');
            val.className = 'detail-value';
            val.textContent = valueText;
            row.appendChild(lbl);
            row.appendChild(val);
            return row;
        }

        async function viewOrderFromShipment(orderUuid) {
            if (!orderUuid) return;

            document.getElementById('modalOrderId').textContent = '';
            showModalLoading();
            document.getElementById('orderModal').classList.add('active');

            try {
                const res = await fetch(API_BASE + '/api/orders/' + orderUuid, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Kan order niet ophalen');
                const json = await res.json();
                const order = json.data;

                const displayId = order.externalDisplayId || order.uuid.slice(0, 8);
                document.getElementById('modalOrderId').textContent = '#' + displayId;

                const customerName = [order.billingFirstName, order.billingLastName].filter(Boolean).join(' ') || '\u2014';
                const shippingAddress = [order.shippingAddress, order.shippingHouseNumber, order.shippingHousenumberAddition || order.shippingHouseNumberAddition].filter(Boolean).join(' ');
                const shippingCityLine = [order.shippingZipcode, order.shippingCity].filter(Boolean).join(' ');
                const email = order.billingEmail || order.shippingEmail || '\u2014';
                const webshop = order.webshopName || '\u2014';
                const statusLabel = STATUS_MAP[order.status] || order.status || '\u2014';
                const statusClass = STATUS_CLASS_MAP[order.status] || 'pending';
                const carrierLabel = extractCarrierLabel(order.shippingMethod);

                const modalBody = document.getElementById('modalBody');
                modalBody.textContent = '';

                // Status row
                const statusRow = document.createElement('div');
                statusRow.style.marginBottom = '16px';
                const badge = document.createElement('span');
                badge.className = 'status-badge ' + statusClass;
                badge.style.fontSize = '14px';
                const dot = document.createElement('span');
                dot.className = 'status-dot';
                badge.appendChild(dot);
                badge.appendChild(document.createTextNode(statusLabel));
                statusRow.appendChild(badge);
                const wsSpan = document.createElement('span');
                wsSpan.style.cssText = 'margin-left:12px;font-size:13px;color:#6b7084;';
                wsSpan.textContent = webshop;
                statusRow.appendChild(wsSpan);
                if (order.totalPaid && order.totalPaid !== '0.00') {
                    const paid = document.createElement('span');
                    paid.style.cssText = 'margin-left:12px;font-weight:600;';
                    paid.textContent = formatCurrency(order.totalPaid);
                    statusRow.appendChild(paid);
                }
                modalBody.appendChild(statusRow);

                // SLA status bar
                var slaBar = createSLABar(order);
                if (slaBar) modalBody.appendChild(slaBar);

                // Detail grid
                const grid = document.createElement('div');
                grid.className = 'detail-grid';

                // Left: Klantgegevens
                const leftSection = document.createElement('div');
                leftSection.className = 'detail-section';
                const h3Left = document.createElement('h3');
                h3Left.textContent = 'Klantgegevens';
                leftSection.appendChild(h3Left);
                leftSection.appendChild(createDetailRow('Naam', customerName));

                // Email row with link
                const emailRow = document.createElement('div');
                emailRow.className = 'detail-row';
                const emailLabel = document.createElement('span');
                emailLabel.className = 'detail-label';
                emailLabel.textContent = 'E-mail';
                const emailVal = document.createElement('span');
                emailVal.className = 'detail-value';
                const emailLink = document.createElement('a');
                emailLink.href = 'mailto:' + email;
                emailLink.style.color = '#2563eb';
                emailLink.textContent = email;
                emailVal.appendChild(emailLink);
                emailRow.appendChild(emailLabel);
                emailRow.appendChild(emailVal);
                leftSection.appendChild(emailRow);

                // Address row
                const addrRow = document.createElement('div');
                addrRow.className = 'detail-row';
                const addrLabel = document.createElement('span');
                addrLabel.className = 'detail-label';
                addrLabel.textContent = 'Verzendadres';
                const addrVal = document.createElement('span');
                addrVal.className = 'detail-value';
                addrVal.style.textAlign = 'right';
                addrVal.appendChild(document.createTextNode(shippingAddress));
                addrVal.appendChild(document.createElement('br'));
                addrVal.appendChild(document.createTextNode(shippingCityLine + (order.shippingCountry ? ', ' + order.shippingCountry : '')));
                addrRow.appendChild(addrLabel);
                addrRow.appendChild(addrVal);
                leftSection.appendChild(addrRow);

                // Right: Verzending
                const rightSection = document.createElement('div');
                rightSection.className = 'detail-section';
                const h3Right = document.createElement('h3');
                h3Right.textContent = 'Verzending';
                rightSection.appendChild(h3Right);
                rightSection.appendChild(createDetailRow('Methode', order.shippingMethod || '\u2014'));
                rightSection.appendChild(createDetailRow('Carrier', carrierLabel));

                // Track & Trace row
                const ttRow = document.createElement('div');
                ttRow.className = 'detail-row';
                const ttLabel = document.createElement('span');
                ttLabel.className = 'detail-label';
                ttLabel.textContent = 'Track & Trace';
                const ttVal = document.createElement('span');
                ttVal.className = 'detail-value';
                const orderShipments = order.shipments || [];
                if (orderShipments.length > 0) {
                    orderShipments.forEach(function(sh) {
                        const code = sh.trackTraceCode || '\u2014';
                        const url = sh.trackTraceUrl || '#';
                        const div = document.createElement('div');
                        div.style.marginBottom = '4px';
                        if (url !== '#') {
                            const a = document.createElement('a');
                            a.href = url;
                            a.target = '_blank';
                            a.style.color = '#2563eb';
                            a.textContent = code;
                            div.appendChild(a);
                        } else {
                            div.textContent = code;
                        }
                        ttVal.appendChild(div);
                    });
                } else {
                    const noTrack = document.createElement('span');
                    noTrack.style.color = '#999';
                    noTrack.textContent = 'Geen tracking info';
                    ttVal.appendChild(noTrack);
                }
                ttRow.appendChild(ttLabel);
                ttRow.appendChild(ttVal);
                rightSection.appendChild(ttRow);
                rightSection.appendChild(createDetailRow('Aangemaakt', formatDateNL(order.createDate)));

                grid.appendChild(leftSection);
                grid.appendChild(rightSection);
                modalBody.appendChild(grid);

                // Products table
                const products = order.products || [];
                const prodSection = document.createElement('div');
                prodSection.className = 'detail-section';
                prodSection.style.marginTop = '24px';
                const h3Prod = document.createElement('h3');
                h3Prod.textContent = 'Bestelde producten (' + products.length + ')';
                prodSection.appendChild(h3Prod);

                const table = document.createElement('table');
                table.className = 'detail-table';
                const thead = document.createElement('thead');
                const headRow = document.createElement('tr');
                ['SKU', 'Product', 'Aantal', 'Gepickt', 'Prijs'].forEach(function(h, i) {
                    const th = document.createElement('th');
                    th.textContent = h;
                    if (i === 2 || i === 3) th.style.textAlign = 'center';
                    if (i === 4) th.style.textAlign = 'right';
                    headRow.appendChild(th);
                });
                thead.appendChild(headRow);
                table.appendChild(thead);

                const tBody = document.createElement('tbody');
                if (products.length === 0) {
                    const emptyTr = document.createElement('tr');
                    const emptyTd = document.createElement('td');
                    emptyTd.colSpan = 5;
                    emptyTd.style.cssText = 'text-align:center;color:#999;padding:20px;';
                    emptyTd.textContent = 'Geen producten';
                    emptyTr.appendChild(emptyTd);
                    tBody.appendChild(emptyTr);
                } else {
                    products.forEach(function(pr) {
                        const tr = document.createElement('tr');
                        const tdSku = document.createElement('td');
                        const code = document.createElement('code');
                        code.textContent = pr.sku || '\u2014';
                        tdSku.appendChild(code);
                        const tdName = document.createElement('td');
                        tdName.textContent = pr.productName || '\u2014';
                        const tdQty = document.createElement('td');
                        tdQty.style.textAlign = 'center';
                        tdQty.textContent = pr.productQuantity || 0;
                        const tdPicked = document.createElement('td');
                        tdPicked.style.textAlign = 'center';
                        tdPicked.textContent = pr.pickedQuantity || 0;
                        const tdPrice = document.createElement('td');
                        tdPrice.style.textAlign = 'right';
                        tdPrice.textContent = formatCurrency(pr.productPrice);
                        tr.appendChild(tdSku);
                        tr.appendChild(tdName);
                        tr.appendChild(tdQty);
                        tr.appendChild(tdPicked);
                        tr.appendChild(tdPrice);
                        tBody.appendChild(tr);
                    });
                }
                table.appendChild(tBody);
                prodSection.appendChild(table);
                modalBody.appendChild(prodSection);
            } catch (e) {
                showModalError(e.message);
            }
        }

        // Initial load
        loadAllShipments();
    </script>
<script src="nav.js"></script>
<script src="ai-insights.js"></script>
</body>
</html>
