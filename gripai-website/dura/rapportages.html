<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportages — Dura Fulfilment</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <script src="auth.js"></script>
    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html" class="logo">Dura <span>Fulfilment</span></a>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="orders.html">Orders</a></li>
                    <li><a href="voorraad.html">Voorraad</a></li>
                    <li><a href="verzendingen.html">Verzendingen</a></li>
                    <li><a href="rapportages.html" class="active">Rapportages</a></li>
                </ul>
            </div>
            <div class="nav-right">
                <div class="global-search" style="position:relative;">
                    <input type="text" id="globalSearch" placeholder="Zoek order, klant, SKU..."
                        style="width:220px;padding:8px 12px 8px 34px;border:1px solid #d2d2d7;border-radius:8px;font-size:13px;font-family:inherit;background:var(--gray-light);outline:none;transition:all 0.2s;"
                        onfocus="this.style.width='300px';this.style.borderColor='var(--blue)';this.style.background='#fff'"
                        onblur="this.style.width='220px';this.style.borderColor='#d2d2d7';this.style.background='var(--gray-light)'"
                        onkeydown="if(event.key==='Enter'){var q=this.value.trim();if(q)window.location.href='orders.html?search='+encodeURIComponent(q);}">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:#8e93a6;pointer-events:none;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </div>
                <a href="warehouse.html" class="btn-warehouse" title="Warehouse Display">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h17.25c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                    Warehouse Display
                </a>
                <div class="nav-user">
                    <div class="user-avatar" id="userAvatar">DF</div>
                    <span class="user-name" id="userName">Demo Account</span>
                </div>
                <button class="hamburger" aria-label="Menu" aria-expanded="false">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Header -->
        <header class="page-header">
            <div class="header-title">
                <h1>Rapportages</h1>
                <p>Inzichten en analyses uit Goedgepickt</p>
            </div>
            <div class="header-actions">
                <select class="form-input" style="width: auto; padding: 12px 16px;" id="periodSelect" onchange="updatePeriod()">
                    <option value="week">Deze week</option>
                    <option value="month">Deze maand</option>
                    <option value="quarter">Dit kwartaal</option>
                    <option value="year">Dit jaar</option>
                </select>
                <button class="btn btn-primary" onclick="downloadReport()">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Download PDF
                </button>
            </div>
        </header>

        <!-- KPI Summary (live) -->
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-value" id="rapOrdersWeek">—</span>
                <span class="stat-label">Orders deze week</span>
            </div>
            <div class="stat-box">
                <span class="stat-value green" id="rapOrdersToday">—</span>
                <span class="stat-label">Orders vandaag</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="rapShipmentsWeek">—</span>
                <span class="stat-label">Verzendingen deze week</span>
            </div>
            <div class="stat-box">
                <span class="stat-value orange" id="rapShipmentsToday">—</span>
                <span class="stat-label">Verzendingen vandaag</span>
            </div>
        </div>

        <!-- Charts Row -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Orders Trend</div>
                        <div class="card-subtitle">Dagelijks overzicht</div>
                    </div>
                </div>
                <div style="height: 300px;">
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Verdeling per Carrier</div>
                        <div class="card-subtitle">Deze week</div>
                    </div>
                </div>
                <div style="height: 300px;">
                    <canvas id="carrierChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Top Performers</div>
                        <div class="card-subtitle">Medewerkers met hoogste output</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Medewerker</th>
                            <th>Orders</th>
                            <th>Gem. tijd</th>
                            <th>Accuracy</th>
                        </tr>
                    </thead>
                    <tbody id="rapportBody"><tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">Bezig met laden...</td></tr></tbody>
                </table>
            </div>
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Piek Uren</div>
                        <div class="card-subtitle">Orders per uur van de dag</div>
                    </div>
                </div>
                <div style="height: 250px;">
                    <canvas id="hoursChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Weekly Reports -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">Beschikbare Rapportages</div>
                    <div class="card-subtitle">Wekelijkse en maandelijkse overzichten</div>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rapport</th>
                        <th>Periode</th>
                        <th>Gegenereerd</th>
                        <th>Status</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Weekrapport Week 6</strong></td>
                        <td>3 - 9 februari 2026</td>
                        <td>Vandaag, 08:00</td>
                        <td><span class="status-badge ok"><span class="status-dot"></span>Gereed</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="downloadReport('week6')">
                                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                PDF
                            </button>
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="downloadExcel('week6')">
                                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125" />
                                </svg>
                                Excel
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Weekrapport Week 5</strong></td>
                        <td>27 jan - 2 feb 2026</td>
                        <td>3 feb, 08:00</td>
                        <td><span class="status-badge ok"><span class="status-dot"></span>Gereed</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                PDF
                            </button>
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125" />
                                </svg>
                                Excel
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Maandrapport Januari</strong></td>
                        <td>1 - 31 januari 2026</td>
                        <td>1 feb, 08:00</td>
                        <td><span class="status-badge ok"><span class="status-dot"></span>Gereed</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                PDF
                            </button>
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125" />
                                </svg>
                                Excel
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        const API_BASE = window.DURA_API_BASE;
        const API_HEADERS = window.DURA_API_HEADERS;

        // ============ LIVE DATA LADEN ============
        async function loadRapportageData() {
            try {
                const res = await fetch(`${API_BASE}/api/dashboard`, { headers: API_HEADERS });
                if (!res.ok) throw new Error('Dashboard API error');
                const json = await res.json();
                const d = json.data;

                document.getElementById('rapOrdersWeek').textContent = (d.orders.week || 0).toLocaleString('nl-NL');
                document.getElementById('rapOrdersToday').textContent = (d.orders.today || 0).toLocaleString('nl-NL');
                document.getElementById('rapShipmentsWeek').textContent = (d.shipments.week || 0).toLocaleString('nl-NL');
                document.getElementById('rapShipmentsToday').textContent = (d.shipments.today || 0).toLocaleString('nl-NL');

                // Update orders chart met orders per dag
                if (d.orders_per_day && ordersChartInstance) {
                    const dagNamen = ['zo', 'ma', 'di', 'wo', 'do', 'vr', 'za'];
                    const sortedDates = Object.keys(d.orders_per_day).sort();
                    const labels = [], values = [];
                    for (let i = 0; i < sortedDates.length; i++) {
                        const date = new Date(sortedDates[i] + 'T00:00:00');
                        labels.push(dagNamen[date.getDay()].charAt(0).toUpperCase() + dagNamen[date.getDay()].slice(1) + ' ' + date.getDate());
                        if (i < sortedDates.length - 1) {
                            values.push(Math.max(0, (d.orders_per_day[sortedDates[i]] || 0) - (d.orders_per_day[sortedDates[i + 1]] || 0)));
                        } else {
                            values.push(d.orders_per_day[sortedDates[i]] || 0);
                        }
                    }
                    ordersChartInstance.data.labels = labels;
                    ordersChartInstance.data.datasets[0].data = values;
                    ordersChartInstance.update();
                }
            } catch (e) {
                console.log('Dashboard data niet beschikbaar:', e.message);
            }
        }

        // Carrier chart live uit shipments
        async function loadCarrierChart() {
            try {
                const res = await fetch(`${API_BASE}/api/shipments/latest?limit=50`, { headers: API_HEADERS });
                if (!res.ok) return;
                const json = await res.json();
                const shipments = json.data || [];
                const carriers = {};
                shipments.forEach(s => {
                    const method = (s.shippingCarrier || s.shippingProvider || s.shippingMethod || '').toUpperCase();
                    let name = 'Overig';
                    if (method.includes('POSTNL') || method.includes('POST NL') || method.includes('MYPARCEL')) name = 'PostNL';
                    else if (method.includes('DHL')) name = 'DHL';
                    else if (method.includes('DPD')) name = 'DPD';
                    else if (method.includes('UPS')) name = 'UPS';
                    carriers[name] = (carriers[name] || 0) + 1;
                });
                if (carrierChartInstance) {
                    carrierChartInstance.data.labels = Object.keys(carriers);
                    carrierChartInstance.data.datasets[0].data = Object.values(carriers);
                    carrierChartInstance.update();
                }
            } catch (e) {
                console.log('Carrier data niet beschikbaar:', e.message);
            }
        }

        // Top performers placeholder
        const rapportBody = document.getElementById('rapportBody');
        if (rapportBody) rapportBody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">Medewerker data niet beschikbaar via API — wordt in toekomstige versie gekoppeld</td></tr>';

        // ============ CHARTS INIT ============
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        const gradient = ordersCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(0, 113, 227, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 113, 227, 0)');

        let ordersChartInstance = new Chart(ordersCtx, {
            type: 'line',
            data: {
                labels: ['—'],
                datasets: [{
                    label: 'Orders',
                    data: [0],
                    borderColor: '#0071e3',
                    backgroundColor: gradient,
                    borderWidth: 2.5,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#0071e3',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#86868b' } },
                    y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#86868b' }, beginAtZero: true }
                }
            }
        });

        let carrierChartInstance = new Chart(document.getElementById('carrierChart'), {
            type: 'doughnut',
            data: {
                labels: ['Laden...'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e5e7eb'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Piek uren chart - verberg (geen live data beschikbaar)
        const hoursCanvas = document.getElementById('hoursChart');
        if (hoursCanvas) {
            new Chart(hoursCanvas, {
                type: 'bar',
                data: {
                    labels: ['Geen data'],
                    datasets: [{ label: 'Orders', data: [0], backgroundColor: '#e5e7eb', borderRadius: 4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
                }
            });
            // Add overlay message
            hoursCanvas.parentElement.style.position = 'relative';
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.8);border-radius:8px;font-size:14px;color:#999;';
            overlay.textContent = 'Piek uren data niet beschikbaar via API';
            hoursCanvas.parentElement.appendChild(overlay);
        }

        // ============ LOAD ============
        loadRapportageData();
        loadCarrierChart();

        function updatePeriod() {
            alert('Periode selectie: in een toekomstige versie wordt dit gekoppeld aan de API.');
        }

        function downloadReport(period) {
            alert('Download: in een toekomstige versie wordt dit gekoppeld aan een export functie.');
        }

        function downloadExcel(period) {
            alert('Download: in een toekomstige versie wordt dit gekoppeld aan een export functie.');
        }
    </script>
<script src="nav.js"></script>
<script src="ai-insights.js"></script>
</body>
</html>
